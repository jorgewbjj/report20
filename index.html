<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>SEAL TOP ROOF - Inspection Report</title>
  
  <!-- MapTiler SDK -->
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet" />
  
  <!-- Cropper.js for photo editing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  
  <style>
    :root {
      --primary-color: #007bff;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --text-color: #2c3e50;
      --border-color: #dee2e6;
      --bg-light: #f8f9fa;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      color: var(--text-color);
      font-size: 16px;
      line-height: 1.5;
      background: #fff;
    }

    /* IMPROVED Container and Spacing */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      background: var(--bg-light);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .logo { 
      height: 80px; 
      margin-bottom: 15px;
      max-width: 100%;
      object-fit: contain;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 28px;
      font-weight: 700;
      margin: 0;
    }

    /* IMPROVED Form Groups with Better Spacing */
    .form-group {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s ease;
    }

    .form-group:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    label { 
      font-weight: 600; 
      display: block; 
      margin-bottom: 8px;
      color: var(--text-color);
      font-size: 14px;
    }
    
    input, select, textarea {
      width: 100%; 
      padding: 12px 16px;
      border: 2px solid var(--border-color); 
      border-radius: 8px;
      font-size: 16px; 
      margin-bottom: 12px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    textarea { 
      min-height: 100px; 
      resize: vertical;
    }

    /* IMPROVED Grid Layout with Better Responsive Design */
    .top-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    /* IMPROVED Mobile Responsiveness */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .top-details { 
        grid-template-columns: 1fr; 
        gap: 15px;
      }
      
      .form-group {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .header {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .logo {
        height: 60px;
      }
      
      button { 
        width: 100% !important;
        margin-bottom: 10px;
      }
      
      .button-group {
        flex-direction: column;
      }
    }

    /* IMPROVED Button Styling */
    .button-group {
      display: flex; 
      gap: 15px; 
      flex-wrap: wrap; 
      margin-top: 25px;
      justify-content: center;
    }
    
    button {
      padding: 14px 24px; 
      border: none; 
      border-radius: 8px;
      cursor: pointer; 
      font-size: 16px; 
      font-weight: 600;
      flex: 1; 
      min-width: 140px;
      transition: all 0.2s ease;
      font-family: inherit;
      text-transform: none;
    }
    
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button:active { 
      transform: translateY(0);
    }
    
    .add-btn { 
      background: var(--success-color); 
      color: #fff; 
    }
    
    .add-btn:hover {
      background: #218838;
    }
    
    .remove-btn { 
      background: var(--danger-color); 
      color: #fff; 
    }
    
    .remove-btn:hover {
      background: #c82333;
    }
    
    .submit-btn { 
      background: var(--primary-color); 
      color: #fff; 
    }
    
    .submit-btn:hover {
      background: #0056b3;
    }

    /* IMPROVED Photo Preview Styling */
    .photo-previews { 
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .photo-wrapper {
      position: relative;
      display: inline-block;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .photo-wrapper img {
      width: 80px; 
      height: 80px;
      object-fit: cover;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      transition: transform 0.2s ease;
    }

    .photo-wrapper:hover img {
      transform: scale(1.05);
    }
    
    .remove-photo-btn {
      position: absolute;
      top: 4px; 
      right: 4px;
      background: rgba(220, 53, 69, 0.9);
      color: #fff; 
      border: none;
      border-radius: 50%;
      width: 22px; 
      height: 22px;
      font-size: 14px;
      line-height: 1;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .remove-photo-btn:hover {
      background: rgba(220, 53, 69, 1);
    }

    /* IMPROVED Address Autocomplete */
    .address-container {
      position: relative;
    }
    
    .address-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .address-suggestion {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background 0.2s ease;
    }
    
    .address-suggestion:hover {
      background: var(--bg-light);
    }
    
    .address-suggestion:last-child {
      border-bottom: none;
    }

    /* IMPROVED Map Styling with Perfect Aspect Ratio */
    .map-container {
      width: 100%;
      height: 350px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      margin-top: 15px;
      position: relative;
      background: var(--bg-light);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .map-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      flex-direction: column;
      color: #6c757d;
      text-align: center;
      padding: 20px;
    }
    
    .map-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    /* MODIFIED: Increased overview map height from 450px to 800px for much bigger display */
    .overview-map {
      height: 800px;
    }
    
    .location-info {
      font-size: 12px;
      color: var(--success-color);
      margin-top: 8px;
      font-weight: 600;
    }

    /* IMPROVED Alert Styling */
    .alert {
      padding: 15px 20px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 10px;
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
      font-weight: 500;
    }
    
    .alert.success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    /* MapTiler Specific Styling */
    .maptiler-map {
      width: 100% !important;
      height: 100% !important;
      border-radius: 8px;
    }

    /* IMPROVED Photo Editing Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 25px;
      border-radius: 15px;
      width: 95%;
      max-width: 900px;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .close {
      color: #aaa;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .close:hover {
      color: var(--danger-color);
      background: rgba(220, 53, 69, 0.1);
    }
    
    .crop-container {
      max-height: 500px;
      margin: 25px 0;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .crop-controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 25px 0;
      justify-content: center;
    }
    
    .crop-controls button {
      padding: 12px 20px;
      font-size: 14px;
      min-width: 120px;
      flex: none;
      font-weight: 600;
    }
    
    .rotate-btn {
      background: #6c757d;
      color: white;
    }
    
    .rotate-btn:hover {
      background: #5a6268;
    }
    
    .crop-btn {
      background: var(--success-color);
      color: white;
    }
    
    .crop-btn:hover {
      background: #218838;
    }
    
    .cancel-btn {
      background: var(--danger-color);
      color: white;
    }
    
    .cancel-btn:hover {
      background: #c82333;
    }
    
    .photo-edit-instructions {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .photo-edit-instructions strong {
      color: var(--primary-color);
    }

    /* IMPROVED Slack Configuration */
    .slack-config {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .slack-config h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #495057;
      font-size: 20px;
    }
    
    .slack-status {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 15px;
      font-weight: 500;
    }
    
    .slack-status.enabled {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    
    .slack-status.disabled {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    /* Hidden Elements */
    .map-capture-canvas {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1200px;
      height: 900px;
      z-index: -1;
    }

    /* IMPROVED Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20000;
    }
    
    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 350px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* IMPROVED Overview Map Preview Notice */
    .overview-preview-notice {
      background: linear-gradient(135deg, #e7f3ff 0%, #cce7ff 100%);
      border: 2px solid #b3d9ff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #0066cc;
      line-height: 1.6;
    }
    
    .overview-preview-notice strong {
      color: #004499;
      font-weight: 600;
    }

    /* IMPROVED Section Headers */
    .section-header {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--primary-color);
    }

    /* IMPROVED Observation Section */
    .observation-section {
      border-left: 4px solid var(--primary-color);
      padding-left: 20px;
      margin-left: 10px;
    }

    /* IMPROVED Mobile Specific Adjustments */
    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
      
      .form-group {
        padding: 12px;
      }
      
      .map-container {
        height: 280px;
      }
      
      /* MODIFIED: Increased mobile overview map height from 320px to 600px */
      .overview-map {
        height: 600px;
      }
      
      .modal-content {
        margin: 5% auto;
        padding: 20px;
        width: 98%;
      }
      
      .crop-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .crop-controls button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>


<body>
  <div class="container">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <h3>Processing...</h3>
        <p>Please wait while we process your request.</p>
      </div>
    </div>

    <!-- MapTiler API Key Alert -->
    <div class="alert success" id="mapsAlert">
      ✅ MapTiler API key detected! Full mapping features are enabled with interactive maps and real-time geocoding.
    </div>

    <!-- IMPROVED Slack Configuration -->
    <div class="slack-config">
      <h3>📢 Direct Slack File Upload - FIXED VERSION</h3>
      <div class="photo-edit-instructions">
        <strong>FIXED:</strong> Improved error handling, better file upload reliability, and enhanced debugging. 
        Configure your Slack Bot Token below to enable file upload to #roof-inspections.
        <br><br>
        <strong>Setup Instructions:</strong> Follow the complete Slack setup guide provided separately for detailed bot creation steps.
      </div>
      <label for="slackBotToken">Slack Bot Token (xoxb-...):</label>
      <input type="password" id="slackBotToken" placeholder="xoxb-your-bot-token-here" />
      <label for="slackChannel">Slack Channel:</label>
      <input type="text" id="slackChannel" placeholder="#roof-inspections" value="#roof-inspections" />
      <div class="slack-status disabled" id="slackStatus">
        Slack file upload disabled - Add Bot Token to enable direct PDF file upload to #roof-inspections
      </div>
    </div>

    <div class="header">
      <img src="Logo seal e slogan@2x (1).png" class="logo" alt="SEAL TOP ROOF Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMjAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMDA3YmZmIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5TRUFMIFRSUCBST09GPC90ZXh0Pgo8dGV4dCB4PSIxMDAiIHk9IjUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5Qcm9mZXNzaW9uYWwgUm9vZiBJbnNwZWN0aW9uPC90ZXh0Pgo8L3N2Zz4K';">
      <h1>Roof Inspection Report</h1>
    </div>

    <div class="top-details">
      <div class="form-group">
        <label>Property:</label>
        <div class="address-container">
          <input type="text" id="address" placeholder="Start typing address or zip code..." required>
          <div class="address-suggestions" id="addressSuggestions"></div>
        </div>
      </div>
      <div class="form-group">
        <label>Inspector Name:</label>
        <select id="inspector" required>
          <option>Arister Cruz</option>
          <option>Jorge Woicikoski</option>
          <option>Pedro Ortiz</option>
        </select>
      </div>
      <div class="form-group">
        <label>Roof Type:</label>
        <select id="roof-type" required>
          <option>TPO</option><option>PVC</option><option>Metal</option>
          <option>Modified</option><option>Shingle</option><option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Roof Condition:</label>
        <select id="roof-condition" required>
          <option>Good</option><option>Fair</option><option>Poor</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Inspection Date:</label>
      <input type="date" id="date" required>
    </div>

    <div id="observations-container"></div>

    <div class="button-group">
      <button class="add-btn" onclick="addObservation()">Add Observation</button>
      <button class="submit-btn" onclick="generatePDF()">Generate PDF &amp; Send to Slack</button>
    </div>

    <!-- IMPROVED Overview Map Section with Much Bigger Size -->
    <div class="form-group">
      <h2 class="section-header">Overview Map - PDF Preview (BIGGER SIZE)</h2>
      <div class="overview-preview-notice">
        <strong>📋 PDF Preview:</strong> This map is now much bigger (800px height) and shows exactly how the overview will appear in your PDF report. 
        The zoom level and satellite imagery match the individual observation maps for consistency.
        <br><br>
        <strong>✨ Interactive Control:</strong> You can zoom, pan, and adjust this map view. 
        The PDF will capture exactly what you see here, including all numbered markers.
        <br><br>
        <strong>🔧 FIXED:</strong> Improved map capture for PDF generation with better marker visibility and higher resolution output.
      </div>
      <div class="map-container overview-map" id="overviewMap">
        <div class="map-placeholder">
          <div class="map-icon">🗺️</div>
          <div><strong>Overview Map - PDF Preview (BIGGER)</strong></div>
          <div style="font-size: 14px; margin-top: 10px;">Shows exactly how the map will appear in the PDF</div>
          <div style="font-size: 12px; margin-top: 8px; color: #6c757d;">Mark locations on individual observation maps to see them here</div>
        </div>
      </div>
    </div>

    <!-- Hidden canvas for map capture -->
    <div id="mapCaptureContainer" class="map-capture-canvas"></div>

    <!-- Enhanced Photo Editing Modal -->
    <div id="photoEditModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>📸 Edit Photo Before Upload</h2>
          <span class="close" onclick="cancelPhotoEdit()">&times;</span>
        </div>
        <div class="photo-edit-instructions">
          <strong>Required:</strong> Please crop and adjust your photo before continuing. 
          This ensures all photos have consistent size and orientation for professional reports.
          <br><br>
          <strong>Instructions:</strong>
          • Use the crop box to select the important area
          • Rotate the image if needed using the buttons below
          • Click "Apply & Continue" when satisfied with the result
        </div>
        <div class="crop-container">
          <img id="cropImage" style="max-width: 100%;">
        </div>
        <div class="crop-controls">
          <button class="rotate-btn" onclick="rotateImage(-90)">↺ Rotate Left</button>
          <button class="rotate-btn" onclick="rotateImage(90)">↻ Rotate Right</button>
          <button class="crop-btn" onclick="applyPhotoEdit()">✓ Apply & Continue</button>
          <button class="cancel-btn" onclick="cancelPhotoEdit()">✗ Cancel Upload</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==== Configuration ====
    const MAPTILER_API_KEY = 'D07LNHRpX8QqmkT39Nza'; // User's actual MapTiler API key
    
    // ==== Global Variables ====
    let observationCount = 0;
    let maptilerLoaded = false;
    let observationMaps = {};
    let overviewMapInstance = null;
    let allMarkers = [];
    let propertyLocation = null; // Store property location for auto-centering
    let currentCropper = null;
    let pendingPhotoFiles = []; // Store files waiting for editing
    let currentObservationDiv = null;

    // ==== DOM refs ====
    const obsContainer = document.getElementById('observations-container');
    const addressInput = document.getElementById('address');
    const addressSuggestions = document.getElementById('addressSuggestions');
    const slackBotTokenInput = document.getElementById('slackBotToken');
    const slackChannelInput = document.getElementById('slackChannel');
    const slackStatus = document.getElementById('slackStatus');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // ==== Enhanced Address Database ====
    const addressDatabase = [
      // Major US Cities with zip codes
      { address: "New York, NY 10001", type: "city" },
      { address: "Los Angeles, CA 90210", type: "city" },
      { address: "Chicago, IL 60601", type: "city" },
      { address: "Houston, TX 77001", type: "city" },
      { address: "Phoenix, AZ 85001", type: "city" },
      { address: "Philadelphia, PA 19101", type: "city" },
      { address: "San Antonio, TX 78201", type: "city" },
      { address: "San Diego, CA 92101", type: "city" },
      { address: "Dallas, TX 75201", type: "city" },
      { address: "San Jose, CA 95101", type: "city" },
      { address: "Austin, TX 78701", type: "city" },
      { address: "Jacksonville, FL 32099", type: "city" },
      { address: "Fort Worth, TX 76101", type: "city" },
      { address: "Columbus, OH 43085", type: "city" },
      { address: "Charlotte, NC 28201", type: "city" },
      { address: "San Francisco, CA 94102", type: "city" },
      { address: "Indianapolis, IN 46201", type: "city" },
      { address: "Seattle, WA 98101", type: "city" },
      { address: "Denver, CO 80201", type: "city" },
      { address: "Boston, MA 02101", type: "city" },
      { address: "El Paso, TX 79901", type: "city" },
      { address: "Detroit, MI 48201", type: "city" },
      { address: "Nashville, TN 37201", type: "city" },
      { address: "Portland, OR 97201", type: "city" },
      { address: "Memphis, TN 38101", type: "city" },
      { address: "Oklahoma City, OK 73101", type: "city" },
      { address: "Las Vegas, NV 89101", type: "city" },
      { address: "Louisville, KY 40201", type: "city" },
      { address: "Baltimore, MD 21201", type: "city" },
      { address: "Milwaukee, WI 53201", type: "city" },
      { address: "Albuquerque, NM 87101", type: "city" },
      { address: "Tucson, AZ 85701", type: "city" },
      { address: "Fresno, CA 93701", type: "city" },
      { address: "Mesa, AZ 85201", type: "city" },
      { address: "Sacramento, CA 95814", type: "city" },
      { address: "Atlanta, GA 30301", type: "city" },
      { address: "Kansas City, MO 64101", type: "city" },
      { address: "Colorado Springs, CO 80901", type: "city" },
      { address: "Miami, FL 33101", type: "city" },
      { address: "Raleigh, NC 27601", type: "city" },
      { address: "Omaha, NE 68101", type: "city" },
      { address: "Long Beach, CA 90801", type: "city" },
      { address: "Virginia Beach, VA 23451", type: "city" },
      { address: "Oakland, CA 94601", type: "city" },
      { address: "Minneapolis, MN 55401", type: "city" },
      { address: "Tulsa, OK 74101", type: "city" },
      { address: "Arlington, TX 76010", type: "city" },
      { address: "Tampa, FL 33601", type: "city" },
      { address: "New Orleans, LA 70112", type: "city" },
      { address: "Wichita, KS 67202", type: "city" }
    ];

    // ==== Initialization ====
    window.addEventListener('DOMContentLoaded', () => {
      setDefaultDate();
      addObservation();
      initializeMapTiler();
      setupAddressAutocomplete();
      setupSlackConfiguration();
    });

    function setDefaultDate() {
      const d = new Date();
      document.getElementById('date').value =
        `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    // ==== Slack Configuration ====
    function setupSlackConfiguration() {
      slackBotTokenInput.addEventListener('input', updateSlackStatus);
      slackChannelInput.addEventListener('input', updateSlackStatus);
      
      // Load saved Slack configuration
      const savedToken = localStorage.getItem('slackBotToken');
      const savedChannel = localStorage.getItem('slackChannel');
      
      if (savedToken) {
        slackBotTokenInput.value = savedToken;
      }
      if (savedChannel) {
        slackChannelInput.value = savedChannel;
      }
      
      updateSlackStatus();
    }

    function updateSlackStatus() {
      const token = slackBotTokenInput.value.trim();
      const channel = slackChannelInput.value.trim() || '#roof-inspections';
      
      // Save to localStorage
      localStorage.setItem('slackBotToken', token);
      localStorage.setItem('slackChannel', channel);
      
      if (token && token.startsWith('xoxb-')) {
        slackStatus.className = 'slack-status enabled';
        slackStatus.textContent = `✅ Slack file upload enabled - PDFs will be uploaded directly to ${channel} as file attachments`;
      } else {
        slackStatus.className = 'slack-status disabled';
        slackStatus.textContent = 'Slack file upload disabled - Add Bot Token (xoxb-...) to enable direct PDF file upload to #roof-inspections';
      }
    }

    // ==== FIXED Slack File Upload Integration with Better Error Handling ====
    async function uploadToSlack(pdfBlob, reportData) {
      const token = slackBotTokenInput.value.trim();
      const channel = slackChannelInput.value.trim() || '#roof-inspections';
      
      if (!token || !token.startsWith('xoxb-')) {
        console.log('Slack bot token not configured, skipping Slack upload');
        showNotification('warning', '⚠️ Slack Upload Skipped', 
          'No valid bot token configured. PDF generated successfully but not uploaded to Slack.');
        return;
      }

      try {
        // Show loading indicator
        showLoadingOverlay('Uploading PDF to Slack...', 'Sending your report directly to the team channel as a file attachment.');

        // FIXED: Better FormData handling and file preparation
        const formData = new FormData();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const cleanAddress = reportData.address.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').slice(0, 30);
        const filename = `Inspection_Report_${cleanAddress}_${timestamp}.pdf`;
        
        // FIXED: Ensure blob is properly formatted
        const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });
        
        // Add the PDF file and metadata with improved formatting
        formData.append('file', pdfFile);
        formData.append('channels', channel.replace('#', ''));
        formData.append('title', `Roof Inspection Report - ${reportData.address}`);
        
        // FIXED: Improved comment formatting without problematic characters
        const comment = `New Roof Inspection Report

Property: ${reportData.address}
Inspector: ${reportData.inspector}
Date: ${reportData.date}
Roof Type: ${reportData.roofType}
Condition: ${reportData.roofCondition}
Issues Found: ${reportData.observations.length} observation(s) with numbered markers

Generated by SEAL TOP ROOF Inspection System`;
        
        formData.append('initial_comment', comment);

        // FIXED: Enhanced error handling and debugging
        console.log('Uploading to Slack with the following details:');
        console.log('- Token:', token.substring(0, 10) + '...');
        console.log('- Channel:', channel);
        console.log('- Filename:', filename);
        console.log('- File size:', pdfBlob.size, 'bytes');

        // Upload file to Slack using files.upload API
        const response = await fetch('https://slack.com/api/files.upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const result = await response.json();
        hideLoadingOverlay();

        // FIXED: Better response handling and error reporting
        console.log('Slack API Response:', result);

        if (result.ok) {
          console.log('✅ PDF uploaded to Slack successfully');
          showNotification('success', `✅ PDF uploaded to ${channel}`, 
            `Your team has been notified. File: ${filename}`);
        } else {
          // FIXED: More detailed error reporting
          const errorMessage = result.error || 'Unknown error';
          const errorDetails = result.response_metadata?.messages || [];
          
          console.error('Slack API Error Details:', {
            error: errorMessage,
            details: errorDetails,
            response: result
          });
          
          throw new Error(`Slack API error: ${errorMessage}${errorDetails.length ? ' - ' + errorDetails.join(', ') : ''}`);
        }
      } catch (error) {
        hideLoadingOverlay();
        console.error('❌ Error uploading to Slack:', error);
        
        // FIXED: More helpful error messages based on error type
        let userMessage = 'The PDF was generated successfully, but Slack upload failed.';
        
        if (error.message.includes('invalid_auth')) {
          userMessage += ' Please check your bot token - it may be invalid or expired.';
        } else if (error.message.includes('channel_not_found')) {
          userMessage += ' The specified channel was not found or the bot lacks access.';
        } else if (error.message.includes('not_in_channel')) {
          userMessage += ' The bot needs to be invited to the channel first.';
        } else if (error.message.includes('file_uploads_disabled')) {
          userMessage += ' File uploads are disabled in this workspace.';
        } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
          userMessage += ' Network connection issue - please check your internet connection.';
        }
        
        showNotification('error', `❌ Failed to upload to Slack`, 
          `${userMessage} Error: ${error.message}`);
      }
    }

    // ==== FIXED Enhanced Notification System ====
    function showNotification(type, title, message) {
      const notification = document.createElement('div');
      notification.className = `alert ${type === 'success' ? 'success' : ''}`;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.maxWidth = '450px';
      notification.style.zIndex = '15000';
      notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      notification.style.cursor = 'pointer';
      
      if (type === 'error') {
        notification.style.backgroundColor = '#f8d7da';
        notification.style.color = '#721c24';
        notification.style.borderColor = '#f5c6cb';
      } else if (type === 'warning') {
        notification.style.backgroundColor = '#fff3cd';
        notification.style.color = '#856404';
        notification.style.borderColor = '#ffeaa7';
      }
      
      notification.innerHTML = `
        <strong>${title}</strong><br>
        <small style="line-height: 1.4;">${message}</small>
        <div style="font-size: 10px; margin-top: 8px; opacity: 0.7;">Click to dismiss</div>
      `;
      
      // FIXED: Click to dismiss functionality
      notification.addEventListener('click', () => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      });
      
      document.body.appendChild(notification);
      
      // Auto-remove after 12 seconds (increased for error messages)
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, type === 'error' ? 15000 : 10000);
    }

    // ==== Loading Overlay Functions ====
    function showLoadingOverlay(title, message) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.querySelector('h3').textContent = title;
      overlay.querySelector('p').textContent = message;
      overlay.style.display = 'flex';
    }

    function hideLoadingOverlay() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }


    // ==== MapTiler Initialization ====
    function initializeMapTiler() {
      if (typeof maptilersdk !== 'undefined') {
        // Set the API key
        maptilersdk.config.apiKey = MAPTILER_API_KEY;
        maptilerLoaded = true;
        
        console.log('MapTiler SDK loaded successfully with API key:', MAPTILER_API_KEY);
      } else {
        console.error('MapTiler SDK not loaded');
      }
    }

    // ==== Enhanced Address Autocomplete ====
    function setupAddressAutocomplete() {
      addressInput.addEventListener('input', handleAddressInput);
      addressInput.addEventListener('blur', () => {
        setTimeout(() => {
          addressSuggestions.style.display = 'none';
        }, 200);
      });
    }

    function handleAddressInput(e) {
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        addressSuggestions.style.display = 'none';
        return;
      }

      // Use MapTiler Geocoding API if available
      if (maptilerLoaded && MAPTILER_API_KEY) {
        searchWithMapTiler(query);
      } else {
        // Fallback to enhanced local suggestions
        showEnhancedLocalSuggestions(query);
      }
    }

    async function searchWithMapTiler(query) {
      try {
        const response = await fetch(
          `https://api.maptiler.com/geocoding/${encodeURIComponent(query)}.json?key=${MAPTILER_API_KEY}&country=US&limit=8`
        );
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          const suggestions = data.features.map(feature => ({
            text: feature.place_name,
            coordinates: feature.center // [lng, lat]
          }));
          showAddressSuggestions(suggestions);
        } else {
          showEnhancedLocalSuggestions(query);
        }
      } catch (error) {
        console.error('MapTiler geocoding error:', error);
        showEnhancedLocalSuggestions(query);
      }
    }

    function showEnhancedLocalSuggestions(query) {
      const suggestions = [];
      const queryLower = query.toLowerCase();
      
      // Check if it's a zip code (5 digits)
      if (/^\d{1,5}$/.test(query)) {
        // Generate zip code suggestions
        const baseZip = query.padEnd(5, '0');
        for (let i = 0; i < 5; i++) {
          const zip = (parseInt(baseZip) + i).toString().padStart(5, '0');
          suggestions.push({
            text: `${zip} - ${getRandomCity()}`,
            coordinates: null
          });
        }
      } else {
        // Search address database
        addressDatabase.forEach(item => {
          if (item.address.toLowerCase().includes(queryLower)) {
            suggestions.push({
              text: item.address,
              coordinates: null
            });
          }
        });

        // Generate street address suggestions
        const streetTypes = ['Street', 'Avenue', 'Road', 'Boulevard', 'Drive', 'Lane', 'Court', 'Place'];
        const cities = ['New York, NY', 'Los Angeles, CA', 'Chicago, IL', 'Houston, TX', 'Phoenix, AZ'];
        
        if (suggestions.length < 5) {
          streetTypes.forEach(type => {
            cities.forEach(city => {
              if (suggestions.length < 8) {
                suggestions.push({
                  text: `${query} ${type}, ${city}`,
                  coordinates: null
                });
              }
            });
          });
        }
      }

      showAddressSuggestions(suggestions.slice(0, 8));
    }

    function getRandomCity() {
      const cities = [
        'New York, NY', 'Los Angeles, CA', 'Chicago, IL', 'Houston, TX',
        'Phoenix, AZ', 'Philadelphia, PA', 'San Antonio, TX', 'San Diego, CA',
        'Dallas, TX', 'San Jose, CA', 'Austin, TX', 'Jacksonville, FL'
      ];
      return cities[Math.floor(Math.random() * cities.length)];
    }

    function showAddressSuggestions(suggestions) {
      addressSuggestions.innerHTML = '';
      
      if (suggestions.length === 0) {
        addressSuggestions.style.display = 'none';
        return;
      }

      suggestions.forEach(suggestion => {
        const div = document.createElement('div');
        div.className = 'address-suggestion';
        div.textContent = suggestion.text;
        div.addEventListener('click', () => {
          addressInput.value = suggestion.text;
          addressSuggestions.style.display = 'none';
          
          // Store property location for auto-centering maps
          if (suggestion.coordinates) {
            propertyLocation = {
              lng: suggestion.coordinates[0],
              lat: suggestion.coordinates[1]
            };
            // Update all existing maps to center on property
            centerAllMapsOnProperty();
          }
        });
        addressSuggestions.appendChild(div);
      });

      addressSuggestions.style.display = 'block';
    }

    // ==== Auto-center Maps on Property ====
    function centerAllMapsOnProperty() {
      if (!propertyLocation) return;
      
      // Center all observation maps
      const observations = document.querySelectorAll('.observation-section');
      observations.forEach(obs => {
        if (obs.map) {
          obs.map.setCenter([propertyLocation.lng, propertyLocation.lat]);
          obs.map.setZoom(18);
        }
      });
      
      // Center overview map with SAME zoom level as observation maps
      if (overviewMapInstance) {
        overviewMapInstance.setCenter([propertyLocation.lng, propertyLocation.lat]);
        overviewMapInstance.setZoom(18); // SAME zoom as observation maps
      }
    }

    // ==== Observations & Maps ====
    function addObservation() {
      const div = document.createElement('div');
      div.className = 'form-group observation-section';
      div.innerHTML = `
        <label>Observation #${observationCount + 1}:</label>
        <textarea class="observation-desc" placeholder="Describe the observation..." required></textarea>
        <label>Upload Photos:</label>
        <div class="photo-edit-instructions">
          <strong>📸 Photo Upload:</strong> Each photo will open an editing window where you can crop and rotate before adding to the report.
        </div>
        <input type="file" class="observation-photos" multiple accept="image/*">
        <label>Issue Location:</label>
        <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">Click on the map to mark the exact location of this issue</div>
        <div class="map-container observation-map" data-observation="${observationCount}">
          <div class="map-placeholder">
            <div class="map-icon">📍</div>
            <div><strong>Interactive Map</strong></div>
            <div style="font-size: 14px; margin-top: 8px;">Click to mark issue location</div>
          </div>
        </div>
        <div class="location-info" style="display: none;"></div>
        <div class="button-group">
          <button type="button" class="remove-btn" onclick="removeObservation(this)">Remove Observation</button>
        </div>
      `;
      obsContainer.appendChild(div);
      observationCount++;
      
      div.photosDataUrls = [];
      div.observationLocation = null;
      
      const input = div.querySelector('.observation-photos');
      input.onchange = e => handlePhotoUpload(div, e.target.files);
      
      // Initialize map for this observation
      setTimeout(() => initObservationMap(div), 100);
    }

    function removeObservation(btn) {
      if (observationCount > 1) {
        btn.closest('.observation-section').remove();
        observationCount--;
        updateObservationNumbers();
        updateOverviewMap();
      } else {
        alert('At least one observation is required');
      }
    }

    function updateObservationNumbers() {
      const sections = document.querySelectorAll('.observation-section');
      sections.forEach((section, index) => {
        section.querySelector('label').textContent = `Observation #${index + 1}:`;
      });
    }

    function initObservationMap(observationDiv) {
      const mapContainer = observationDiv.querySelector('.observation-map');
      
      if (maptilerLoaded) {
        try {
          // Clear any existing placeholder content
          mapContainer.innerHTML = '';
          
          // Use property location if available, otherwise default to NYC
          const center = propertyLocation ? 
            [propertyLocation.lng, propertyLocation.lat] : 
            [-74.0060, 40.7128];
          
          // Initialize MapTiler map with CONSISTENT zoom level
          const map = new maptilersdk.Map({
            container: mapContainer,
            style: maptilersdk.MapStyle.SATELLITE,
            center: center,
            zoom: propertyLocation ? 18 : 15, // CONSISTENT zoom level
            preserveDrawingBuffer: true, // For PDF capture
            antialias: true // Better quality
          });

          map.on('load', () => {
            console.log('Observation map loaded successfully');
          });

          map.on('click', (e) => {
            const location = {
              lat: e.lngLat.lat,
              lng: e.lngLat.lng
            };
            
            // Remove existing marker
            if (observationDiv.marker) {
              observationDiv.marker.remove();
            }
            
            // Add new marker
            observationDiv.marker = new maptilersdk.Marker({
              color: '#dc2626'
            })
            .setLngLat([location.lng, location.lat])
            .addTo(map);
            
            observationDiv.observationLocation = location;
            updateLocationDisplay(observationDiv);
            updateOverviewMap();
          });

          observationDiv.map = map;
          
          // If location already exists, add marker
          if (observationDiv.observationLocation) {
            observationDiv.marker = new maptilersdk.Marker({
              color: '#dc2626'
            })
            .setLngLat([observationDiv.observationLocation.lng, observationDiv.observationLocation.lat])
            .addTo(map);
            map.setCenter([observationDiv.observationLocation.lng, observationDiv.observationLocation.lat]);
          }
        } catch (error) {
          console.error('Error initializing MapTiler map:', error);
          initFallbackMap(observationDiv, mapContainer);
        }
      } else {
        // Fallback: clickable placeholder
        initFallbackMap(observationDiv, mapContainer);
      }
    }

    function initFallbackMap(observationDiv, mapContainer) {
      mapContainer.style.cursor = 'pointer';
      mapContainer.addEventListener('click', () => {
        // Use property location if available for mock coordinates
        const baseLocation = propertyLocation || { lat: 40.7128, lng: -74.0060 };
        const mockLocation = {
          lat: baseLocation.lat + (Math.random() - 0.5) * 0.01,
          lng: baseLocation.lng + (Math.random() - 0.5) * 0.01
        };
        
        observationDiv.observationLocation = mockLocation;
        mapContainer.innerHTML = `
          <div class="map-placeholder">
            <div class="map-icon">📍</div>
            <div><strong>Location Marked!</strong></div>
            <div style="font-size: 14px; margin-top: 8px;">Click again to change location</div>
          </div>
        `;
        updateLocationDisplay(observationDiv);
        updateOverviewMap();
      });
    }

    function updateLocationDisplay(observationDiv) {
      const locationInfo = observationDiv.querySelector('.location-info');
      if (observationDiv.observationLocation) {
        const { lat, lng } = observationDiv.observationLocation;
        locationInfo.textContent = `Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        locationInfo.style.display = 'block';
      } else {
        locationInfo.style.display = 'none';
      }
    }

    // ==== FIXED Overview Map with Better Display and PDF Capture ====
    function updateOverviewMap() {
      const overviewMapContainer = document.getElementById('overviewMap');
      const observations = document.querySelectorAll('.observation-section');
      const locationsWithMarkers = Array.from(observations).filter(obs => obs.observationLocation);
      
      if (locationsWithMarkers.length === 0) {
        overviewMapContainer.innerHTML = `
          <div class="map-placeholder">
            <div class="map-icon">🗺️</div>
            <div><strong>Overview Map - PDF Preview (BIGGER)</strong></div>
            <div style="font-size: 14px; margin-top: 10px;">Shows exactly how the map will appear in the PDF</div>
            <div style="font-size: 12px; margin-top: 8px; color: #6c757d;">Mark locations on individual observation maps to see them here</div>
          </div>
        `;
        return;
      }

      if (maptilerLoaded) {
        try {
          // Clear existing content and initialize MapTiler overview map
          if (!overviewMapInstance) {
            overviewMapContainer.innerHTML = '';
            
            // Use property location if available, otherwise default
            const center = propertyLocation ? 
              [propertyLocation.lng, propertyLocation.lat] : 
              [-74.0060, 40.7128];
            
            // SAME settings as observation maps for EXACT consistency
            overviewMapInstance = new maptilersdk.Map({
              container: overviewMapContainer,
              style: maptilersdk.MapStyle.SATELLITE, // SAME style
              center: center,
              zoom: propertyLocation ? 18 : 15, // SAME zoom level as observation maps
              preserveDrawingBuffer: true, // CRITICAL for PDF capture
              antialias: true, // Better quality
              // FIXED: Additional settings for better PDF capture
              fadeDuration: 0, // Disable fade animations for consistent capture
              interactive: true // Keep interactive for user control
            });

            overviewMapInstance.on('load', () => {
              console.log('Overview map loaded successfully with PDF capture settings');
            });
          }

          // Clear existing markers
          allMarkers.forEach(marker => marker.remove());
          allMarkers = [];

          // Add NUMBERED markers for all observations with ENHANCED visibility
          locationsWithMarkers.forEach((obs, index) => {
            // FIXED: Create larger, more visible numbered marker elements
            const markerElement = document.createElement('div');
            markerElement.style.cssText = `
              background-color: #dc2626;
              color: white;
              width: 40px;
              height: 40px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
              font-size: 18px;
              border: 3px solid white;
              box-shadow: 0 4px 8px rgba(0,0,0,0.5);
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              z-index: 1000;
              position: relative;
            `;
            markerElement.textContent = (index + 1).toString();
            
            const marker = new maptilersdk.Marker({
              element: markerElement,
              anchor: 'center' // FIXED: Better marker positioning
            })
            .setLngLat([obs.observationLocation.lng, obs.observationLocation.lat])
            .addTo(overviewMapInstance);
            
            allMarkers.push(marker);
          });

          // FIXED: Better map centering and zoom for PDF capture
          if (propertyLocation) {
            overviewMapInstance.setCenter([propertyLocation.lng, propertyLocation.lat]);
            overviewMapInstance.setZoom(18); // SAME zoom as observation maps
          } else if (locationsWithMarkers.length > 0) {
            // Center on first location with same zoom
            const firstLocation = locationsWithMarkers[0].observationLocation;
            overviewMapInstance.setCenter([firstLocation.lng, firstLocation.lat]);
            overviewMapInstance.setZoom(18); // SAME zoom as observation maps
          }
        } catch (error) {
          console.error('Error updating overview map:', error);
          showFallbackOverview(locationsWithMarkers, overviewMapContainer);
        }
      } else {
        // Fallback overview display
        showFallbackOverview(locationsWithMarkers, overviewMapContainer);
      }
    }

    function showFallbackOverview(locationsWithMarkers, container) {
      container.innerHTML = `
        <div class="map-placeholder">
          <div class="map-icon">🗺️</div>
          <div><strong>Overview Map - PDF Preview (BIGGER)</strong></div>
          <div style="font-size: 14px; margin-top: 10px;">${locationsWithMarkers.length} issue location(s) marked</div>
          <div style="font-size: 12px; margin-top: 8px; color: #6c757d;">
            ${locationsWithMarkers.map((obs, i) => `Issue ${i+1}: ${obs.observationLocation.lat.toFixed(4)}, ${obs.observationLocation.lng.toFixed(4)}`).join('<br>')}
          </div>
        </div>
      `;
    }

    // ==== COMPLETELY FIXED High-Quality Map Capture for PDF ====
    async function createHighQualityMapCaptureForPDF(observations) {
      if (!maptilerLoaded || observations.length === 0 || !overviewMapInstance) {
        console.log('Map capture not available - using fallback');
        return null;
      }

      try {
        console.log('Creating high-quality map capture for PDF...');
        
        // FIXED: Ensure map is fully loaded and rendered
        await new Promise(resolve => {
          if (overviewMapInstance.loaded()) {
            resolve();
          } else {
            overviewMapInstance.on('load', resolve);
          }
        });

        // FIXED: Wait for all tiles and markers to be fully rendered
        await new Promise(resolve => setTimeout(resolve, 3000));

        // FIXED: Force map repaint to ensure all elements are rendered
        overviewMapInstance.resize();
        await new Promise(resolve => setTimeout(resolve, 1000));

        // FIXED: Trigger a redraw to ensure markers are visible
        overviewMapInstance.triggerRepaint();
        await new Promise(resolve => setTimeout(resolve, 1000));

        // FIXED: Get the canvas with better error handling
        const canvas = overviewMapInstance.getCanvas();
        
        if (!canvas) {
          throw new Error('Canvas not available from overview map');
        }

        // FIXED: Verify canvas has content
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const hasContent = imageData.data.some(pixel => pixel !== 0);
        
        if (!hasContent) {
          console.warn('Canvas appears to be empty, but proceeding with capture');
        }

        // FIXED: Create high-quality image with maximum settings
        const mapImageDataUrl = canvas.toDataURL('image/png', 1.0);

        // FIXED: Verify the captured image has reasonable size
        if (mapImageDataUrl.length < 1000) {
          throw new Error('Captured image appears to be too small or empty');
        }

        console.log('High-quality map capture successful:', {
          canvasSize: `${canvas.width}x${canvas.height}`,
          dataUrlLength: mapImageDataUrl.length,
          markersCount: allMarkers.length
        });

        return mapImageDataUrl;
      } catch (error) {
        console.error('Error creating map capture:', error);
        
        // FIXED: Try alternative capture method using html2canvas as fallback
        try {
          console.log('Attempting fallback capture using html2canvas...');
          const mapContainer = document.getElementById('overviewMap');
          
          if (typeof html2canvas !== 'undefined') {
            const canvas = await html2canvas(mapContainer, {
              useCORS: true,
              allowTaint: true,
              scale: 2, // Higher resolution
              width: mapContainer.offsetWidth,
              height: mapContainer.offsetHeight,
              backgroundColor: null
            });
            
            const fallbackDataUrl = canvas.toDataURL('image/png', 1.0);
            console.log('Fallback capture successful');
            return fallbackDataUrl;
          }
        } catch (fallbackError) {
          console.error('Fallback capture also failed:', fallbackError);
        }
        
        return null;
      }
    }


    // ==== Enhanced Photo Handling with Mandatory Editing ====
    function handlePhotoUpload(section, files) {
      if (files.length === 0) return;
      
      // Store the section and files for processing
      currentObservationDiv = section;
      pendingPhotoFiles = Array.from(files);
      
      // Process first photo
      processNextPhoto();
    }

    function processNextPhoto() {
      if (pendingPhotoFiles.length === 0) {
        // All photos processed
        currentObservationDiv = null;
        return;
      }
      
      const file = pendingPhotoFiles.shift();
      const reader = new FileReader();
      
      reader.onload = e => {
        // Show mandatory photo editing modal
        openPhotoEditor(e.target.result);
      };
      
      reader.readAsDataURL(file);
    }

    function openPhotoEditor(imageDataUrl) {
      showLoadingOverlay('Preparing Photo Editor...', 'Please wait while we load the photo editing tools.');
      
      const modal = document.getElementById('photoEditModal');
      const cropImage = document.getElementById('cropImage');
      
      cropImage.src = imageDataUrl;
      modal.style.display = 'block';
      
      // Initialize cropper after image loads
      cropImage.onload = () => {
        hideLoadingOverlay();
        
        if (currentCropper) {
          currentCropper.destroy();
        }
        currentCropper = new Cropper(cropImage, {
          aspectRatio: 1, // Square crop
          viewMode: 1,
          autoCropArea: 0.8,
          responsive: true,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          ready: function() {
            console.log('Photo editor ready');
          }
        });
      };
    }

    function applyPhotoEdit() {
      if (currentCropper && currentObservationDiv) {
        showLoadingOverlay('Processing Photo...', 'Applying your edits and preparing the image...');
        
        const canvas = currentCropper.getCroppedCanvas({
          width: 800,
          height: 800,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high'
        });
        
        const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
        currentObservationDiv.photosDataUrls.push(croppedDataUrl);
        updatePreview(currentObservationDiv);
        
        closePhotoEditor();
        hideLoadingOverlay();
        
        // Process next photo if any
        processNextPhoto();
      }
    }

    function cancelPhotoEdit() {
      // Skip this photo and process next one
      closePhotoEditor();
      processNextPhoto();
    }

    function closePhotoEditor() {
      const modal = document.getElementById('photoEditModal');
      modal.style.display = 'none';
      
      if (currentCropper) {
        currentCropper.destroy();
        currentCropper = null;
      }
    }

    function rotateImage(degrees) {
      if (currentCropper) {
        currentCropper.rotate(degrees);
      }
    }

    function updatePreview(sec) {
      sec.querySelectorAll('.photo-previews').forEach(e=>e.remove());
      if(sec.photosDataUrls?.length){
        const ctr = document.createElement('div'); ctr.className='photo-previews';
        sec.photosDataUrls.forEach((u,i)=>{
          const w = document.createElement('div'); w.className='photo-wrapper';
          const im = document.createElement('img'); im.src=u;
          
          const removeBtn = document.createElement('button');
          removeBtn.className='remove-photo-btn'; removeBtn.textContent='×';
          removeBtn.onclick=()=>{ sec.photosDataUrls.splice(i,1); updatePreview(sec); };
          
          w.appendChild(im); w.appendChild(removeBtn); ctr.appendChild(w);
        });
        sec.appendChild(ctr);
      }
    }

    // ==== COMPLETELY FIXED PDF Generation with High-Quality Overview Map ====
    async function generatePDF(){
      try {
        const address = document.getElementById('address').value.trim();
        const inspector = document.getElementById('inspector').value;
        const roofType = document.getElementById('roof-type').value;
        const roofCondition = document.getElementById('roof-condition').value;
        const date = document.getElementById('date').value;

        if (!address) {
          alert('Please enter a property address');
          return;
        }

        // Show loading overlay
        showLoadingOverlay('Generating PDF with High-Quality Overview Map...', 'Creating professional report with enhanced overview map capture and numbered markers.');

        // Check if jsPDF is available
        if (typeof window.jspdf === 'undefined') {
          hideLoadingOverlay();
          alert('PDF library not loaded. Please refresh the page and try again.');
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ compress: true });
        const w = doc.internal.pageSize.getWidth();
        let y = 20;

        // Get logo image (try user's logo first, fallback to embedded)
        let logoDataUrl = null;
        try {
          const logoImg = document.querySelector('.logo');
          if (logoImg && logoImg.src && !logoImg.src.includes('data:')) {
            // Convert user's PNG logo to base64
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = logoImg.naturalWidth;
            canvas.height = logoImg.naturalHeight;
            ctx.drawImage(logoImg, 0, 0);
            logoDataUrl = canvas.toDataURL('image/png');
          }
        } catch (logoError) {
          console.error('Error processing user logo:', logoError);
        }

        // Fallback to embedded SVG logo
        if (!logoDataUrl) {
          logoDataUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMjAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMDA3YmZmIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5TRUFMIFRSUCBST09GPC90ZXh0Pgo8dGV4dCB4PSIxMDAiIHk9IjUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5Qcm9mZXNzaW9uYWwgUm9vZiBJbnNwZWN0aW9uPC90ZXh0Pgo8L3N2Zz4K';
        }
        
        try {
          // Add logo (60x24 size for better visibility)
          const logoFormat = logoDataUrl.includes('data:image/png') ? 'PNG' : 'SVG';
          doc.addImage(logoDataUrl, logoFormat, (w-60)/2, y, 60, 24);
          y += 30;
        } catch (logoError) {
          console.error('Error adding logo:', logoError);
          // Continue without logo
        }

        // Header
        doc.setFontSize(18); 
        doc.setTextColor(19,29,53);
        doc.text('SEAL TOP ROOF - Inspection Report',w/2,y,{align:'center'});
        y+=20;

        // Report details - NO EMOJIS, plain text only
        doc.setFontSize(12); 
        doc.setTextColor(0);
        const lines=[
          `Property: ${address}`,
          `Inspector: ${inspector}`,
          `Date: ${date}`,
          `Roof Type: ${roofType}`,
          `Roof Condition: ${roofCondition}`
        ];
        lines.forEach(l=>{
          if(y>280){ doc.addPage(); y=20; }
          doc.text(l,20,y); y+=8;
        });
        y+=8;

        // Observations
        const secs = [...document.querySelectorAll('.observation-section')];
        const savedObs=[];
        const imgSize=(w-45)/2;

        secs.forEach((sec,i)=>{
          const idx=i+1;
          const desc=sec.querySelector('.observation-desc').value.trim();
          const photos=sec.photosDataUrls||[];
          const location=sec.observationLocation;
          savedObs.push({desc,photos,location});
          
          const txt=doc.splitTextToSize(desc,w-40);
          const txtH=txt.length*6+20;
          const imgsH=Math.ceil(photos.length/2)*(imgSize+5);
          if(y+txtH+imgsH>280){ doc.addPage(); y=20; }
          
          doc.setFont('helvetica','bold');
          doc.text(`Observation #${idx}:`,20,y); y+=6;
          
          // Location without emoji - plain text only
          if(location) {
            doc.setFont('helvetica','normal');
            doc.text(`Location: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`,20,y); y+=6;
          }
          
          doc.setFont('helvetica','normal');
          txt.forEach(line=>{ doc.text(line,20,y); y+=6; });
          y+=4;
          
          for(let j=0;j<photos.length;j+=2){
            if(y+imgSize>280){ doc.addPage(); y=20; }
            try {
              doc.addImage(photos[j],'JPEG',20,y,imgSize,imgSize,undefined,'SLOW');
              if(photos[j+1]){
                doc.addImage(photos[j+1],'JPEG',20+imgSize+5,y,imgSize,imgSize,undefined,'SLOW');
              }
            } catch (imgError) {
              console.error('Error adding image to PDF:', imgError);
            }
            y+=imgSize+5;
          }
        });

        // FIXED: Overview map page (landscape) with HIGH-QUALITY capture
        const locationsCount = savedObs.filter(obs => obs.location).length;
        if (locationsCount > 0) {
          console.log('Creating HIGH-QUALITY overview map for PDF...');
          
          // FIXED: Create HIGH-QUALITY map capture with better error handling
          const mapImageDataUrl = await createHighQualityMapCaptureForPDF(savedObs);
          
          // Add landscape page
          doc.addPage('a4', 'landscape');
          const landscapeW = doc.internal.pageSize.getWidth();
          const landscapeH = doc.internal.pageSize.getHeight();
          y = 20;
          
          // Add logo to landscape page too
          try {
            const logoFormat = logoDataUrl.includes('data:image/png') ? 'PNG' : 'SVG';
            doc.addImage(logoDataUrl, logoFormat, (landscapeW-60)/2, y, 60, 24);
            y += 30;
          } catch (logoError) {
            console.error('Error adding logo to landscape page:', logoError);
          }
          
          doc.setFont('helvetica','bold');
          doc.setFontSize(16);
          // NO EMOJI - plain text only
          doc.text('Overview Map - All Issues with Numbered Markers (HIGH QUALITY)', landscapeW/2, y, {align: 'center'}); 
          y += 15;
          
          doc.setFont('helvetica','normal');
          doc.setFontSize(12);
          doc.text(`Total issue locations marked: ${locationsCount}`, 20, y); 
          y += 15;
          
          const mapWidth = landscapeW - 40;
          const mapHeight = landscapeH - 140; // Space for coordinates
          
          if (mapImageDataUrl) {
            // FIXED: Add HIGH-QUALITY map image with better sizing
            try {
              console.log('Adding HIGH-QUALITY map image to PDF');
              
              // FIXED: Create a test image to get dimensions
              const testImg = new Image();
              testImg.onload = () => {
                console.log('Map image dimensions:', testImg.width, 'x', testImg.height);
              };
              testImg.src = mapImageDataUrl;
              
              // FIXED: Better aspect ratio handling
              const maxWidth = mapWidth;
              const maxHeight = mapHeight;
              
              // Use the full available space for maximum quality
              doc.addImage(mapImageDataUrl, 'PNG', 20, y, maxWidth, maxHeight, undefined, 'SLOW');
              y += maxHeight + 10;
              
              console.log('HIGH-QUALITY map image added successfully');
            } catch (mapImageError) {
              console.error('Error adding map image to PDF:', mapImageError);
              // Fallback to enhanced visual representation
              addEnhancedVisualMapRepresentation();
            }
          } else {
            // Enhanced fallback: Visual representation with numbered markers
            console.log('Using enhanced fallback visual representation with numbered markers');
            addEnhancedVisualMapRepresentation();
          }
          
          function addEnhancedVisualMapRepresentation() {
            // Draw map border
            doc.setDrawColor(0);
            doc.setLineWidth(1);
            doc.rect(20, y, mapWidth, mapHeight);
            
            // Add map title inside
            doc.setFontSize(14);
            doc.text('HIGH-QUALITY Overview Map with Numbered Markers', 30, y + 20);
            doc.setFontSize(10);
            doc.text('(Map capture was not available - showing marker locations)', 30, y + 35);
            
            // Enhanced visual representation of NUMBERED markers
            savedObs.forEach((obs, index) => {
              if (obs.location) {
                const markerX = 50 + (index * 60);
                const markerY = y + 80 + (Math.floor(index / 4) * 40);
                
                // Draw enhanced numbered circle marker
                doc.setFillColor(220, 38, 38); // Red color
                doc.circle(markerX, markerY, 15, 'F'); // Larger markers
                
                // Add white border
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(3);
                doc.circle(markerX, markerY, 15, 'S');
                
                // Add number inside marker
                doc.setFontSize(18);
                doc.setTextColor(255, 255, 255);
                doc.text(`${index + 1}`, markerX - 5, markerY + 6);
                doc.setTextColor(0, 0, 0);
              }
            });
            
            y += mapHeight + 10;
          }
          
          // Add coordinates list at the bottom with small font
          doc.setFont('helvetica','bold');
          doc.setFontSize(12);
          doc.text('Issue Locations Coordinates:', 20, y);
          y += 8;
          
          doc.setFont('helvetica','normal');
          doc.setFontSize(9); // Small font for coordinates
          savedObs.forEach((obs, index) => {
            if (obs.location) {
              const coordText = `Issue ${index + 1}: ${obs.location.lat.toFixed(6)}, ${obs.location.lng.toFixed(6)}`;
              doc.text(coordText, 20, y);
              y += 6;
            }
          });
          
          // Add note about map quality
          y += 5;
          doc.setFontSize(8);
          doc.text('Note: This overview shows the high-quality capture of the interactive map with all numbered markers.', 20, y);
          y += 4;
          doc.text('The PDF captures the precise view and zoom level that was displayed on the website with enhanced visibility.', 20, y);
        }

        // Save PDF locally
        const blob=doc.output('blob');
        const filename=`Inspection_Report_${address.replace(/[^a-zA-Z0-9]/g,'_').slice(0,50)}_${date}.pdf`;
        doc.save(filename);
        
        const reportData = {
          address,
          inspector,
          roofType,
          roofCondition,
          date,
          observations:savedObs,
          propertyLocation
        };
        
        hideLoadingOverlay();
        
        // Upload directly to Slack with improved error handling
        await uploadToSlack(blob, reportData);
        
        showNotification('success', '✅ PDF Generated with HIGH-QUALITY Overview Map!', 
          'Professional report created with enhanced overview map capture and improved Slack upload functionality.');

      } catch(err){
        hideLoadingOverlay();
        console.error('PDF Generation Error:', err);
        showNotification('error', '❌ Error generating PDF', `PDF generation failed: ${err.message}`);
      }
    }
  </script>
</body>
</html>

