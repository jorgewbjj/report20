<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEAL TOP ROOF - Inspection Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.css" />
    <script src="https://unpkg.com/cropperjs/dist/cropper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet" />
    <style>
        :root {
            --primary-blue: #007bff;
            --light-blue: #e3f2fd;
            --dark-blue: #0056b3;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        
        .observation-card {
            background: white;
            border: 2px solid var(--light-blue);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .observation-header {
            background: var(--primary-blue);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #dee2e6;
            margin: 1rem 0;
            position: relative;
        }
        
        .overview-map-container {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid var(--primary-blue);
            margin: 1.5rem 0;
            position: relative;
            background: #f8f9fa;
        }
        
        .btn-primary {
            background: var(--primary-blue);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        
        .btn-success {
            background: #28a745;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.4);
        }
        
        .btn-danger {
            background: #dc3545;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.4);
        }
        
        .action-buttons {
            text-align: center;
            margin: 2rem 0;
        }
        
        .action-buttons button {
            margin: 0.5rem;
            min-width: 200px;
        }
        
        .overview-section {
            background: white;
            border: 3px solid var(--primary-blue);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 25px rgba(0,123,255,0.2);
        }
        
        .overview-title {
            color: var(--primary-blue);
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .address-suggestion {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .address-suggestion:hover {
            background-color: var(--light-blue);
        }
        
        .address-suggestion:last-child {
            border-bottom: none;
        }
        
        .location-marker {
            color: #dc3545;
            font-weight: bold;
            margin-top: 0.5rem;
        }
        
        .photo-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 0.25rem;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .photo-preview:hover {
            border-color: var(--primary-blue);
            transform: scale(1.05);
        }
        
        .modal {
            z-index: 2000;
        }
        
        .modal-dialog {
            max-width: 90vw;
        }
        
        .cropper-container {
            max-height: 70vh;
        }
        
        .slack-config {
            background: linear-gradient(135deg, #4A154B, #611f69);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(74,21,75,0.3);
        }
        
        .slack-status {
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-weight: 600;
        }
        
        .slack-enabled {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .slack-disabled {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .info-box h6 {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .coordinates-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 300px;
            }
            
            .overview-map-container {
                height: 400px;
            }
            
            .action-buttons button {
                min-width: auto;
                width: 100%;
                margin: 0.25rem 0;
            }
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #cce7ff, #b3d9ff);
            color: #0c5460;
        }
        
        /* Hidden canvas for map capture */
        #mapCaptureCanvas {
            position: absolute;
            top: -9999px;
            left: -9999px;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <!-- MapTiler API Key Status -->
    <div class="alert alert-success">
        <strong>✅ MapTiler API key detected!</strong> Full mapping features are enabled with interactive maps and real-time geocoding.
    </div>

    <!-- Slack Configuration -->
    <div class="slack-config">
        <h4>📢 Direct Slack File Upload - CORRECTED</h4>
        <p><strong>FIXED:</strong> PDF files are now uploaded directly to your Slack channel as file attachments. Configure your Slack Bot Token below to enable file upload to #roof-inspections.</p>
        
        <div class="row">
            <div class="col-md-8">
                <label for="slackToken" class="form-label">Slack Bot Token (xoxb-...):</label>
                <input type="text" class="form-control" id="slackToken" placeholder="xoxb-your-bot-token-here">
            </div>
            <div class="col-md-4">
                <label for="slackChannel" class="form-label">Slack Channel:</label>
                <input type="text" class="form-control" id="slackChannel" value="#roof-inspections" placeholder="#roof-inspections">
            </div>
        </div>
        
        <div id="slackStatus" class="slack-status slack-disabled">
            Slack file upload disabled - Add Bot Token (xoxb-...) to enable direct PDF file upload to #roof-inspections
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>Roof Inspection Report</h1>
        <p>Professional Documentation & Analysis</p>
    </div>

    <!-- Main Form -->
    <div class="form-container">
        <div class="form-row">
            <div class="form-group">
                <label for="propertyAddress">Property:</label>
                <input type="text" class="form-control" id="propertyAddress" placeholder="Start typing address or zip code...">
                <div id="addressSuggestions" class="address-suggestions" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label for="inspectorName">Inspector Name:</label>
                <select class="form-select" id="inspectorName">
                    <option value="Arister Cruz">Arister Cruz</option>
                    <option value="Jorge Woicikoski">Jorge Woicikoski</option>
                    <option value="Pedro Ortiz">Pedro Ortiz</option>
                </select>
            </div>
            <div class="form-group">
                <label for="roofType">Roof Type:</label>
                <select class="form-select" id="roofType">
                    <option value="TPO">TPO</option>
                    <option value="PVC">PVC</option>
                    <option value="Metal">Metal</option>
                    <option value="Modified">Modified</option>
                    <option value="Shingle">Shingle</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="roofCondition">Roof Condition:</label>
                <select class="form-select" id="roofCondition">
                    <option value="Good">Good</option>
                    <option value="Fair">Fair</option>
                    <option value="Poor">Poor</option>
                </select>
            </div>
            <div class="form-group">
                <label for="inspectionDate">Inspection Date:</label>
                <input type="date" class="form-control" id="inspectionDate">
            </div>
        </div>
    </div>

    <!-- Observations Container -->
    <div id="observationsContainer">
        <!-- Observations will be added here dynamically -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button type="button" class="btn btn-success" onclick="addObservation()">Add Observation</button>
        <button type="button" class="btn btn-primary" onclick="generatePDF()">Generate PDF & Send to Slack</button>
    </div>

    <!-- Overview Map Section -->
    <div class="overview-section">
        <div class="overview-title">Overview Map - PDF Preview (CORRECTED)</div>
        
        <div class="info-box">
            <h6>📋 CORRECTED PDF Preview:</h6>
            <p>This map shows exactly how the overview will appear in your PDF report. The zoom level and satellite imagery match the individual observation maps for consistency.</p>
            
            <h6>✨ CORRECTED Interactive Control:</h6>
            <p>You can zoom, pan, and adjust this map view. The PDF will capture exactly what you see here, including all numbered markers at LARGE size.</p>
            
            <h6>🔧 FIXED Issues:</h6>
            <p>• Overview map now captures correctly in PDF<br>• Map is much larger in PDF report<br>• Numbered markers display properly</p>
        </div>
        
        <div class="overview-map-container">
            <div id="overviewMap" style="width: 100%; height: 100%;"></div>
        </div>
        
        <div id="overviewInfo" class="coordinates-display">
            🗺️ <strong>Overview Map - PDF Preview (CORRECTED)</strong><br>
            Shows exactly how the map will appear in the PDF<br>
            Mark locations on individual observation maps to see them here
        </div>
    </div>

    <!-- Hidden canvas for map capture -->
    <canvas id="mapCaptureCanvas" width="1600" height="1200"></canvas>

    <!-- Photo Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">📸 Edit Photo - Crop & Rotate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-outline-primary me-2" onclick="rotateImage(-90)">↺ Rotate Left</button>
                        <button type="button" class="btn btn-outline-primary" onclick="rotateImage(90)">↻ Rotate Right</button>
                    </div>
                    <div class="cropper-container">
                        <img id="cropImage" style="max-width: 100%;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyCrop()">Apply Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // MapTiler API Configuration
        const MAPTILER_API_KEY = 'D07LNHRpX8QqmkT39Nza';
        maptilersdk.config.apiKey = MAPTILER_API_KEY;

        // Global variables
        let observationCount = 0;
        let observationMaps = {};
        let overviewMap = null;
        let overviewMarkers = [];
        let currentPropertyLocation = null;
        let cropper = null;
        let currentPhotoCallback = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('inspectionDate').value = new Date().toISOString().split('T')[0];
            
            // Add first observation by default
            addObservation();
            
            // Initialize overview map
            initializeOverviewMap();
            
            // Setup address autocomplete
            setupAddressAutocomplete();
            
            // Setup Slack configuration
            setupSlackConfig();
        });

        // Setup Slack configuration
        function setupSlackConfig() {
            const tokenInput = document.getElementById('slackToken');
            const channelInput = document.getElementById('slackChannel');
            const statusDiv = document.getElementById('slackStatus');

            function updateSlackStatus() {
                const token = tokenInput.value.trim();
                const channel = channelInput.value.trim();
                
                if (token.startsWith('xoxb-') && channel) {
                    statusDiv.className = 'slack-status slack-enabled';
                    statusDiv.textContent = `✅ Slack file upload enabled - PDFs will be sent to ${channel}`;
                } else {
                    statusDiv.className = 'slack-status slack-disabled';
                    statusDiv.textContent = 'Slack file upload disabled - Add Bot Token (xoxb-...) to enable direct PDF file upload to #roof-inspections';
                }
            }

            tokenInput.addEventListener('input', updateSlackStatus);
            channelInput.addEventListener('input', updateSlackStatus);
        }

        // Setup address autocomplete
        function setupAddressAutocomplete() {
            const addressInput = document.getElementById('propertyAddress');
            const suggestionsDiv = document.getElementById('addressSuggestions');
            let debounceTimer;

            addressInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    searchAddresses(query);
                }, 300);
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // Search addresses using MapTiler Geocoding API
        async function searchAddresses(query) {
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            try {
                const response = await fetch(`https://api.maptiler.com/geocoding/${encodeURIComponent(query)}.json?key=${MAPTILER_API_KEY}&limit=5`);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    displayAddressSuggestions(data.features);
                } else {
                    // Fallback suggestions
                    displayFallbackSuggestions(query);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                displayFallbackSuggestions(query);
            }
        }

        // Display address suggestions
        function displayAddressSuggestions(features) {
            const suggestionsDiv = document.getElementById('addressSuggestions');
            suggestionsDiv.innerHTML = '';
            
            features.forEach(feature => {
                const suggestion = document.createElement('div');
                suggestion.className = 'address-suggestion';
                suggestion.textContent = feature.place_name;
                suggestion.addEventListener('click', () => selectAddress(feature));
                suggestionsDiv.appendChild(suggestion);
            });
            
            suggestionsDiv.style.display = 'block';
        }

        // Display fallback suggestions
        function displayFallbackSuggestions(query) {
            const suggestions = [
                `${query}, Florida, United States`,
                `${query}, California, United States`,
                `${query}, Texas, United States`,
                `${query}, New York, United States`,
                `${query}, Georgia, United States`
            ];
            
            const suggestionsDiv = document.getElementById('addressSuggestions');
            suggestionsDiv.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'address-suggestion';
                div.textContent = suggestion;
                div.addEventListener('click', () => selectFallbackAddress(suggestion));
                suggestionsDiv.appendChild(div);
            });
            
            suggestionsDiv.style.display = 'block';
        }

        // Select address from MapTiler results
        function selectAddress(feature) {
            const addressInput = document.getElementById('propertyAddress');
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            addressInput.value = feature.place_name;
            suggestionsDiv.style.display = 'none';
            
            // Store location for map centering
            currentPropertyLocation = {
                lng: feature.center[0],
                lat: feature.center[1]
            };
            
            // Update all maps to center on this location
            updateAllMapsLocation();
        }

        // Select fallback address
        function selectFallbackAddress(address) {
            const addressInput = document.getElementById('propertyAddress');
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            addressInput.value = address;
            suggestionsDiv.style.display = 'none';
            
            // Use default coordinates for common locations
            const defaultLocations = {
                'Florida': { lng: -81.5158, lat: 27.6648 },
                'California': { lng: -119.4179, lat: 36.7783 },
                'Texas': { lng: -99.9018, lat: 31.9686 },
                'New York': { lng: -74.0060, lat: 40.7128 },
                'Georgia': { lng: -83.6431, lat: 33.7490 }
            };
            
            for (const [state, coords] of Object.entries(defaultLocations)) {
                if (address.includes(state)) {
                    currentPropertyLocation = coords;
                    break;
                }
            }
            
            if (!currentPropertyLocation) {
                currentPropertyLocation = { lng: -74.0060, lat: 40.7128 }; // Default to NYC
            }
            
            updateAllMapsLocation();
        }

        // Update all maps to center on property location
        function updateAllMapsLocation() {
            if (!currentPropertyLocation) return;
            
            // Update observation maps
            Object.values(observationMaps).forEach(map => {
                if (map) {
                    map.setCenter([currentPropertyLocation.lng, currentPropertyLocation.lat]);
                    map.setZoom(18);
                }
            });
            
            // Update overview map
            if (overviewMap) {
                overviewMap.setCenter([currentPropertyLocation.lng, currentPropertyLocation.lat]);
                overviewMap.setZoom(18);
            }
        }

        // Initialize overview map
        function initializeOverviewMap() {
            try {
                overviewMap = new maptilersdk.Map({
                    container: 'overviewMap',
                    style: maptilersdk.MapStyle.SATELLITE,
                    center: [-74.0060, 40.7128], // Default to NYC
                    zoom: 18,
                    preserveDrawingBuffer: true, // CRITICAL for PDF capture
                    antialias: true
                });

                overviewMap.on('load', () => {
                    console.log('Overview map loaded successfully');
                });
            } catch (error) {
                console.error('Error initializing overview map:', error);
            }
        }

        // Add new observation
        function addObservation() {
            observationCount++;
            const container = document.getElementById('observationsContainer');
            
            const observationDiv = document.createElement('div');
            observationDiv.className = 'observation-card';
            observationDiv.id = `observation-${observationCount}`;
            
            observationDiv.innerHTML = `
                <div class="observation-header">
                    Observation #${observationCount}:
                </div>
                
                <div class="mb-3">
                    <textarea class="form-control" id="description-${observationCount}" rows="3" placeholder="Describe the observation..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Upload Photos:</strong></label>
                    <div class="alert alert-info">
                        📸 <strong>Photo Upload:</strong> Each photo will open an editing window where you can crop and rotate before adding to the report.
                    </div>
                    <input type="file" class="form-control" id="photos-${observationCount}" multiple accept="image/*" onchange="handlePhotoUpload(${observationCount}, this)">
                    <div id="photoPreview-${observationCount}" class="mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Issue Location:</strong></label>
                    <p class="text-muted">Click on the map to mark the exact location of this issue</p>
                    <div class="map-container">
                        <div id="map-${observationCount}" style="width: 100%; height: 100%;"></div>
                    </div>
                    <div id="coordinates-${observationCount}" class="location-marker" style="display: none;"></div>
                </div>
                
                <button type="button" class="btn btn-danger" onclick="removeObservation(${observationCount})">Remove Observation</button>
            `;
            
            container.appendChild(observationDiv);
            
            // Initialize map for this observation
            initializeObservationMap(observationCount);
        }

        // Initialize observation map
        function initializeObservationMap(observationId) {
            try {
                const map = new maptilersdk.Map({
                    container: `map-${observationId}`,
                    style: maptilersdk.MapStyle.SATELLITE,
                    center: currentPropertyLocation ? [currentPropertyLocation.lng, currentPropertyLocation.lat] : [-74.0060, 40.7128],
                    zoom: 18,
                    preserveDrawingBuffer: true, // CRITICAL for PDF capture
                    antialias: true
                });

                let marker = null;

                map.on('load', () => {
                    console.log(`Observation map ${observationId} loaded successfully`);
                });

                map.on('click', (e) => {
                    const coords = e.lngLat;
                    
                    // Remove existing marker
                    if (marker) {
                        marker.remove();
                    }
                    
                    // Add new marker
                    marker = new maptilersdk.Marker({ color: '#dc3545' })
                        .setLngLat([coords.lng, coords.lat])
                        .addTo(map);
                    
                    // Update coordinates display
                    const coordsDiv = document.getElementById(`coordinates-${observationId}`);
                    coordsDiv.innerHTML = `📍 Location Marked! GPS: ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
                    coordsDiv.style.display = 'block';
                    
                    // Update overview map
                    updateOverviewMap();
                });

                observationMaps[observationId] = map;
            } catch (error) {
                console.error(`Error initializing observation map ${observationId}:`, error);
            }
        }

        // Update overview map with all markers
        function updateOverviewMap() {
            if (!overviewMap) return;
            
            // Clear existing markers
            overviewMarkers.forEach(marker => marker.remove());
            overviewMarkers = [];
            
            let allCoordinates = [];
            let markerNumber = 1;
            
            // Add markers for each observation
            for (let i = 1; i <= observationCount; i++) {
                const coordsDiv = document.getElementById(`coordinates-${i}`);
                if (coordsDiv && coordsDiv.style.display !== 'none') {
                    const coordsText = coordsDiv.textContent;
                    const match = coordsText.match(/GPS: ([-\d.]+), ([-\d.]+)/);
                    
                    if (match) {
                        const lat = parseFloat(match[1]);
                        const lng = parseFloat(match[2]);
                        allCoordinates.push([lng, lat]);
                        
                        // Create LARGE numbered marker for better visibility
                        const markerElement = document.createElement('div');
                        markerElement.style.cssText = `
                            width: 60px;
                            height: 60px;
                            background-color: #dc3545;
                            border: 4px solid white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: 24px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                            font-family: Arial, sans-serif;
                        `;
                        markerElement.textContent = markerNumber;
                        
                        const marker = new maptilersdk.Marker({ element: markerElement })
                            .setLngLat([lng, lat])
                            .addTo(overviewMap);
                        
                        overviewMarkers.push(marker);
                        markerNumber++;
                    }
                }
            }
            
            // Update overview info
            const overviewInfo = document.getElementById('overviewInfo');
            if (allCoordinates.length > 0) {
                let infoText = `🗺️ <strong>Overview Map - ${allCoordinates.length} Issue Location${allCoordinates.length > 1 ? 's' : ''} Marked</strong><br>`;
                infoText += `Total issue locations marked: ${allCoordinates.length}<br><br>`;
                
                allCoordinates.forEach((coord, index) => {
                    infoText += `Issue ${index + 1}: ${coord[1].toFixed(6)}, ${coord[0].toFixed(6)}<br>`;
                });
                
                overviewInfo.innerHTML = infoText;
            } else {
                overviewInfo.innerHTML = `🗺️ <strong>Overview Map - PDF Preview (CORRECTED)</strong><br>Shows exactly how the map will appear in the PDF<br>Mark locations on individual observation maps to see them here`;
            }
        }

        // Handle photo upload with mandatory editing
        function handlePhotoUpload(observationId, input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            // Process photos one by one with mandatory editing
            processPhotosSequentially(files, 0, observationId, []);
        }

        // Process photos sequentially with mandatory editing
        function processPhotosSequentially(files, index, observationId, processedPhotos) {
            if (index >= files.length) {
                // All photos processed, display them
                displayProcessedPhotos(observationId, processedPhotos);
                return;
            }
            
            const file = files[index];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Show crop modal for this photo
                showCropModal(e.target.result, (croppedDataUrl) => {
                    processedPhotos.push(croppedDataUrl);
                    // Process next photo
                    processPhotosSequentially(files, index + 1, observationId, processedPhotos);
                });
            };
            
            reader.readAsDataURL(file);
        }

        // Show crop modal
        function showCropModal(imageSrc, callback) {
            const modal = new bootstrap.Modal(document.getElementById('cropModal'));
            const image = document.getElementById('cropImage');
            
            image.src = imageSrc;
            currentPhotoCallback = callback;
            
            modal.show();
            
            // Initialize cropper when modal is shown
            document.getElementById('cropModal').addEventListener('shown.bs.modal', function() {
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false
                });
            }, { once: true });
        }

        // Rotate image in cropper
        function rotateImage(degrees) {
            if (cropper) {
                cropper.rotate(degrees);
            }
        }

        // Apply crop and continue
        function applyCrop() {
            if (cropper && currentPhotoCallback) {
                const canvas = cropper.getCroppedCanvas({
                    width: 800,
                    height: 800,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });
                
                const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                currentPhotoCallback(croppedDataUrl);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cropModal'));
                modal.hide();
                
                // Cleanup
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                currentPhotoCallback = null;
            }
        }

        // Display processed photos
        function displayProcessedPhotos(observationId, photos) {
            const previewDiv = document.getElementById(`photoPreview-${observationId}`);
            
            photos.forEach((photoDataUrl, index) => {
                const img = document.createElement('img');
                img.src = photoDataUrl;
                img.className = 'photo-preview';
                img.title = `Photo ${index + 1} - Click to view full size`;
                img.onclick = () => {
                    // Show full size photo in modal
                    const fullSizeModal = document.createElement('div');
                    fullSizeModal.innerHTML = `
                        <div class="modal fade" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Photo ${index + 1}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body text-center">
                                        <img src="${photoDataUrl}" style="max-width: 100%; height: auto;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(fullSizeModal);
                    const modal = new bootstrap.Modal(fullSizeModal.querySelector('.modal'));
                    modal.show();
                    
                    fullSizeModal.querySelector('.modal').addEventListener('hidden.bs.modal', () => {
                        document.body.removeChild(fullSizeModal);
                    });
                };
                
                previewDiv.appendChild(img);
            });
        }

        // Remove observation
        function removeObservation(observationId) {
            const observationDiv = document.getElementById(`observation-${observationId}`);
            if (observationDiv) {
                observationDiv.remove();
            }
            
            // Clean up map
            if (observationMaps[observationId]) {
                observationMaps[observationId].remove();
                delete observationMaps[observationId];
            }
            
            // Update overview map
            updateOverviewMap();
        }

        // CORRECTED: Capture overview map with proper rendering
        async function captureOverviewMapForPDF() {
            if (!overviewMap) {
                console.error('Overview map not available');
                return null;
            }

            try {
                // Force map to be ready and trigger repaint
                await new Promise(resolve => {
                    if (overviewMap.loaded()) {
                        resolve();
                    } else {
                        overviewMap.once('load', resolve);
                    }
                });

                // Trigger repaint and wait for idle state
                overviewMap.triggerRepaint();
                await new Promise(resolve => {
                    overviewMap.once('idle', resolve);
                });

                // Additional wait for markers to fully render
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Get the map container
                const mapContainer = document.getElementById('overviewMap');
                
                // Capture with high quality settings
                const canvas = await html2canvas(mapContainer, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2, // High resolution
                    width: 1600,
                    height: 1200,
                    backgroundColor: '#ffffff',
                    logging: false,
                    imageTimeout: 15000,
                    removeContainer: false
                });

                return canvas.toDataURL('image/jpeg', 0.95);
            } catch (error) {
                console.error('Error capturing overview map:', error);
                return null;
            }
        }

        // Generate PDF and send to Slack
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            try {
                // Get form data
                const propertyAddress = document.getElementById('propertyAddress').value || 'Not specified';
                const inspectorName = document.getElementById('inspectorName').value;
                const roofType = document.getElementById('roofType').value;
                const roofCondition = document.getElementById('roofCondition').value;
                const inspectionDate = document.getElementById('inspectionDate').value;
                
                // Add logo if available
                try {
                    const logoImg = await loadImage('Logo seal e slogan@2x (1).png');
                    pdf.addImage(logoImg, 'PNG', 20, 10, 60, 30);
                } catch (error) {
                    console.log('Custom logo not found, using default');
                    // Add default SEAL TOP ROOF text
                    pdf.setFontSize(20);
                    pdf.setTextColor(0, 123, 255);
                    pdf.text('SEAL TOP ROOF MANAGEMENT', 20, 25);
                    pdf.setFontSize(12);
                    pdf.text('Where quality meets the sky', 20, 35);
                }
                
                // Add report header
                pdf.setFontSize(24);
                pdf.setTextColor(0, 0, 0);
                pdf.text('Roof Inspection Report', 20, 60);
                
                // Add report details
                pdf.setFontSize(12);
                let yPos = 80;
                pdf.text(`Property: ${propertyAddress}`, 20, yPos);
                yPos += 10;
                pdf.text(`Inspector: ${inspectorName}`, 20, yPos);
                yPos += 10;
                pdf.text(`Roof Type: ${roofType}`, 20, yPos);
                yPos += 10;
                pdf.text(`Condition: ${roofCondition}`, 20, yPos);
                yPos += 10;
                pdf.text(`Date: ${inspectionDate}`, 20, yPos);
                yPos += 20;
                
                // Add observations
                for (let i = 1; i <= observationCount; i++) {
                    const observationDiv = document.getElementById(`observation-${i}`);
                    if (!observationDiv) continue;
                    
                    const description = document.getElementById(`description-${i}`).value || 'No description provided';
                    const coordsDiv = document.getElementById(`coordinates-${i}`);
                    
                    // Check if we need a new page
                    if (yPos > 250) {
                        pdf.addPage();
                        yPos = 20;
                        
                        // Add logo to new page
                        try {
                            const logoImg = await loadImage('Logo seal e slogan@2x (1).png');
                            pdf.addImage(logoImg, 'PNG', 20, 10, 60, 30);
                        } catch (error) {
                            pdf.setFontSize(16);
                            pdf.setTextColor(0, 123, 255);
                            pdf.text('SEAL TOP ROOF MANAGEMENT', 20, 20);
                        }
                        yPos = 50;
                    }
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 123, 255);
                    pdf.text(`Observation ${i}:`, 20, yPos);
                    yPos += 15;
                    
                    pdf.setFontSize(12);
                    pdf.setTextColor(0, 0, 0);
                    const lines = pdf.splitTextToSize(description, 170);
                    pdf.text(lines, 20, yPos);
                    yPos += lines.length * 5 + 10;
                    
                    // Add GPS coordinates if available
                    if (coordsDiv && coordsDiv.style.display !== 'none') {
                        const coordsText = coordsDiv.textContent;
                        const match = coordsText.match(/GPS: ([-\d.]+), ([-\d.]+)/);
                        if (match) {
                            pdf.text(`Location: ${match[1]}, ${match[2]}`, 20, yPos);
                            yPos += 10;
                        }
                    }
                    
                    yPos += 10;
                }
                
                // CORRECTED: Add overview map page (LANDSCAPE) with LARGE map
                pdf.addPage('l'); // Landscape orientation
                
                // Add logo to overview page
                try {
                    const logoImg = await loadImage('Logo seal e slogan@2x (1).png');
                    pdf.addImage(logoImg, 'PNG', 20, 10, 60, 30);
                } catch (error) {
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 123, 255);
                    pdf.text('SEAL TOP ROOF MANAGEMENT', 20, 20);
                }
                
                // Overview map title
                pdf.setFontSize(18);
                pdf.setTextColor(0, 0, 0);
                pdf.text('Overview Map - All Issues with Numbered Markers (CORRECTED)', 20, 60);
                
                // Count marked locations
                let markedLocations = 0;
                for (let i = 1; i <= observationCount; i++) {
                    const coordsDiv = document.getElementById(`coordinates-${i}`);
                    if (coordsDiv && coordsDiv.style.display !== 'none') {
                        markedLocations++;
                    }
                }
                
                pdf.setFontSize(12);
                pdf.text(`Total issue locations marked: ${markedLocations}`, 20, 75);
                
                // CORRECTED: CAPTURE OVERVIEW MAP - MUCH LARGER SIZE WITH PROPER RENDERING
                if (overviewMap && markedLocations > 0) {
                    try {
                        console.log('Starting overview map capture...');
                        
                        // Show loading message
                        pdf.setFontSize(12);
                        pdf.text('Capturing overview map with numbered markers...', 20, 90);
                        
                        // Capture the overview map with corrected method
                        const mapDataUrl = await captureOverviewMapForPDF();
                        
                        if (mapDataUrl) {
                            // CORRECTED: Add MUCH LARGER map to PDF (landscape page)
                            // Use almost the entire landscape page width and height
                            pdf.addImage(mapDataUrl, 'JPEG', 20, 85, 270, 160); // MUCH LARGER: 270x160 vs previous 250x140
                            console.log('Overview map captured and added to PDF successfully');
                        } else {
                            throw new Error('Map capture returned null');
                        }
                        
                    } catch (error) {
                        console.error('Error capturing overview map:', error);
                        // Fallback: Add text indicating map capture failed
                        pdf.setFontSize(12);
                        pdf.text('Overview map capture failed. Please check the interactive map above.', 20, 100);
                        pdf.text('Error: ' + error.message, 20, 115);
                    }
                } else {
                    pdf.setFontSize(12);
                    pdf.text('No issue locations marked yet. Mark locations on individual observation maps.', 20, 100);
                }
                
                // Add coordinates list below the map
                if (markedLocations > 0) {
                    pdf.setFontSize(14);
                    pdf.text('Issue Locations Coordinates:', 20, 255);
                    
                    let coordYPos = 265;
                    let issueNumber = 1;
                    
                    for (let i = 1; i <= observationCount; i++) {
                        const coordsDiv = document.getElementById(`coordinates-${i}`);
                        if (coordsDiv && coordsDiv.style.display !== 'none') {
                            const coordsText = coordsDiv.textContent;
                            const match = coordsText.match(/GPS: ([-\d.]+), ([-\d.]+)/);
                            if (match) {
                                pdf.setFontSize(9); // Small font as requested
                                pdf.text(`Issue ${issueNumber}: ${match[1]}, ${match[2]}`, 20, coordYPos);
                                coordYPos += 8;
                                issueNumber++;
                            }
                        }
                    }
                }
                
                // Add note about overview map
                pdf.setFontSize(10);
                pdf.text('CORRECTED: This overview shows the exact same view as the interactive map on the website with all numbered markers.', 20, 285);
                pdf.text('The PDF captures the precise view and zoom level that was displayed on the website with enhanced quality.', 20, 295);
                
                // CORRECTED: Send to Slack with proper file upload
                await sendPDFToSlack(pdf, propertyAddress);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        // CORRECTED: Send PDF to Slack with proper file upload
        async function sendPDFToSlack(pdf, propertyAddress) {
            const slackToken = document.getElementById('slackToken').value.trim();
            const slackChannel = document.getElementById('slackChannel').value.trim() || '#roof-inspections';
            
            if (!slackToken.startsWith('xoxb-')) {
                alert('PDF generated successfully! To send to Slack, please configure your Slack Bot Token (xoxb-...)');
                // Still download the PDF locally
                pdf.save(`Inspection_Report_${propertyAddress.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
                return;
            }
            
            try {
                // Convert PDF to blob
                const pdfBlob = pdf.output('blob');
                const fileName = `Inspection_Report_${propertyAddress.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // CORRECTED: Create FormData for file upload with proper headers
                const formData = new FormData();
                formData.append('file', pdfBlob, fileName);
                formData.append('channels', slackChannel.replace('#', '')); // Remove # from channel name
                formData.append('title', `Roof Inspection Report - ${propertyAddress}`);
                formData.append('initial_comment', `🏠 **SEAL TOP ROOF Inspector - Roof Inspection Report Generated**\n\n📋 **Property:** ${propertyAddress}\n👨‍🔧 **Inspector:** ${document.getElementById('inspectorName').value}\n📅 **Date:** ${document.getElementById('inspectionDate').value}\n🏠 **Roof Type:** ${document.getElementById('roofType').value}\n⚖️ **Condition:** ${document.getElementById('roofCondition').value}\n📍 **Observations:** ${observationCount} issue(s) documented\n\n📄 **Download PDF Report** ⬇️`);
                
                // CORRECTED: Upload file to Slack with proper error handling
                const response = await fetch('https://slack.com/api/files.upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${slackToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    alert('✅ PDF generated and sent to Slack successfully!\n\nThe PDF includes:\n• CORRECTED overview map with numbered markers\n• LARGE map size in landscape format\n• All issue locations with GPS coordinates');
                } else {
                    console.error('Slack upload error:', result);
                    alert(`❌ Error sending to Slack: ${result.error || 'Unknown error'}\n\nPossible issues:\n• Invalid Bot Token\n• Missing permissions (files:write, chat:write)\n• Channel not found\n\nPDF will be downloaded locally instead.`);
                    pdf.save(fileName);
                }
                
            } catch (error) {
                console.error('Error sending to Slack:', error);
                alert('❌ Error sending to Slack. PDF will be downloaded locally instead.\n\nError: ' + error.message);
                pdf.save(`Inspection_Report_${propertyAddress.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }

        // Helper function to load image
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }
    </script>
</body>
</html>

