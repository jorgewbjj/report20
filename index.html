<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEAL TOP ROOF - Inspection Report</title>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    
    <!-- Cropper.js for Image Cropping -->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.css">
    <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 10px;
                margin: 0;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .observation-card {
                margin: 10px 0;
                padding: 15px;
            }
            
            .map-container {
                height: 250px !important;
            }
            
            .overview-map {
                height: 200px !important;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
                padding: 12px;
                font-size: 16px;
            }
            
            .slack-config {
                padding: 15px;
            }
            
            .slack-inputs {
                flex-direction: column;
                gap: 10px;
            }
            
            .slack-inputs input {
                width: 100% !important;
                margin: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 24px !important;
            }
            
            .header p {
                font-size: 14px !important;
            }
            
            .form-group label {
                font-size: 14px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
        }

        /* API Status */
        .api-status {
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-left: 4px solid #28a745;
            margin: 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-status::before {
            content: "✅";
            font-size: 16px;
        }

        /* Slack Configuration */
        .slack-config {
            background: linear-gradient(135deg, #6a4c93 0%, #9b59b6 100%);
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .slack-config::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .slack-config h3 {
            font-size: 20px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slack-config h3::before {
            content: "📢";
            font-size: 24px;
        }

        .slack-inputs {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .slack-inputs > div {
            flex: 1;
            min-width: 250px;
        }

        .slack-inputs label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .slack-inputs input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .slack-inputs input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .slack-inputs input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
        }

        .slack-status {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 18px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Form Styles */
        .form-section {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* Address Autocomplete */
        .address-container {
            position: relative;
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* Observation Cards */
        .observation-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .observation-card:hover {
            border-color: #2196F3;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.1);
        }

        .observation-header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        /* Photo Upload */
        .photo-upload {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px dashed #2196F3;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            border-color: #1976D2;
        }

        .photo-upload-icon {
            font-size: 48px;
            color: #2196F3;
            margin-bottom: 10px;
        }

        .photo-upload-text {
            color: #1976D2;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .photo-upload-subtext {
            color: #666;
            font-size: 14px;
        }

        /* Image Cropping Modal */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            padding: 20px;
        }

        .crop-container {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            margin: auto;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            overflow: hidden;
        }

        .crop-header {
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .crop-content {
            padding: 20px;
            max-height: 70vh;
            overflow: auto;
        }

        .crop-image {
            max-width: 100%;
            max-height: 50vh;
        }

        .crop-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .crop-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .crop-btn-primary {
            background: #2196F3;
            color: white;
        }

        .crop-btn-primary:hover {
            background: #1976D2;
        }

        .crop-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .crop-btn-secondary:hover {
            background: #5a6268;
        }

        /* Maps */
        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e1e8ed;
            margin: 15px 0;
            position: relative;
        }

        .map-label {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            margin-bottom: 10px;
            display: inline-block;
        }

        .map-instructions {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .location-marker {
            color: #e74c3c;
            font-weight: 600;
            margin-top: 10px;
            padding: 8px 12px;
            background: #fff5f5;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
            transform: translateY(-2px);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        /* Overview Map Section */
        .overview-section {
            background: #f8f9fa;
            border: 2px solid #2196F3;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        .overview-title {
            color: #2196F3;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }

        .overview-info {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .overview-info h4 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .overview-info p {
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .overview-map {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #2196F3;
            position: relative;
        }

        .overview-stats {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e1e8ed;
        }

        .overview-stats h4 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .overview-stats p {
            color: #666;
            margin: 5px 0;
            font-size: 14px;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Touch-friendly improvements for mobile */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .suggestion-item {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .mapboxgl-ctrl-group button {
                width: 44px !important;
                height: 44px !important;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles for keyboard navigation */
        .btn:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #2196F3;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- API Status -->
        <div class="api-status">
            <span id="apiStatus">Checking MapTiler API...</span>
        </div>

        <!-- Slack Configuration -->
        <div class="slack-config">
            <h3>Direct Slack File Upload - ENHANCED</h3>
            <p><strong>ENHANCED:</strong> PDF files are now uploaded directly to your Slack channel as file attachments with landscape overview maps. Configure your Slack Bot Token below to enable file upload to #roof-inspections.</p>
            
            <div class="slack-inputs">
                <div>
                    <label for="slackToken">Slack Bot Token (xoxb-...):</label>
                    <input type="password" id="slackToken" placeholder="xoxb-your-bot-token-here">
                </div>
                <div>
                    <label for="slackChannel">Slack Channel:</label>
                    <input type="text" id="slackChannel" placeholder="#roof-inspections" value="#roof-inspections">
                </div>
            </div>
            
            <div class="slack-status" id="slackStatus">
                Slack file upload disabled - Add Bot Token (xoxb-...) to enable direct PDF file upload to #roof-inspections
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>Roof Inspection Report</h1>
            <p>Professional Documentation & Analysis - Enhanced Mobile & Landscape PDF</p>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <div class="form-grid">
                <div class="form-group">
                    <label for="propertyAddress">Property:</label>
                    <div class="address-container">
                        <input type="text" id="propertyAddress" placeholder="Start typing address or zip code...">
                        <div class="address-suggestions" id="addressSuggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="inspectorName">Inspector Name:</label>
                    <select id="inspectorName">
                        <option value="Arister Cruz">Arister Cruz</option>
                        <option value="Jorge Woicikoski">Jorge Woicikoski</option>
                        <option value="Pedro Ortiz">Pedro Ortiz</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="roofType">Roof Type:</label>
                    <select id="roofType">
                        <option value="TPO">TPO</option>
                        <option value="PVC">PVC</option>
                        <option value="Metal">Metal</option>
                        <option value="Modified">Modified</option>
                        <option value="Shingle">Shingle</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="roofCondition">Roof Condition:</label>
                    <select id="roofCondition">
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="inspectionDate">Inspection Date:</label>
                    <input type="date" id="inspectionDate">
                </div>
            </div>

            <!-- Observations Container -->
            <div id="observationsContainer">
                <!-- Observations will be added here dynamically -->
            </div>

            <!-- Action Buttons -->
            <div class="btn-group">
                <button class="btn btn-success" onclick="addObservation()">Add Observation</button>
                <button class="btn btn-primary" onclick="generatePDF()">Generate PDF & Send to Slack</button>
            </div>

            <!-- Overview Map Section -->
            <div class="overview-section">
                <h2 class="overview-title">Overview Map - PDF Preview (ENHANCED LANDSCAPE)</h2>
                
                <div class="overview-info">
                    <h4>📋 ENHANCED PDF Preview:</h4>
                    <p>This map shows exactly how the overview will appear in your PDF report in <strong>LANDSCAPE MODE</strong> for maximum visibility. The zoom level and satellite imagery match the individual observation maps for consistency.</p>
                    
                    <h4>✨ ENHANCED Interactive Control:</h4>
                    <p>You can zoom, pan, and adjust this map view. The PDF will capture exactly what you see here, including all numbered markers at LARGE size in landscape format.</p>
                    
                    <h4>🔧 ENHANCED Features:</h4>
                    <p>• Overview map now captures correctly in PDF in <strong>LANDSCAPE MODE</strong><br>
                    • Map is much larger in PDF report with landscape orientation<br>
                    • Numbered markers display properly with enhanced visibility<br>
                    • Image cropping functionality added before upload</p>
                </div>

                <div class="map-container overview-map" id="overviewMapContainer">
                    <div id="overviewMap"></div>
                </div>

                <div class="overview-stats" id="overviewStats">
                    <h4>🗺️ Overview Map - PDF Preview (ENHANCED LANDSCAPE)</h4>
                    <p>Shows exactly how the map will appear in the PDF in landscape mode</p>
                    <p>Mark locations on individual observation maps to see them here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Cropping Modal -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-container">
            <div class="crop-header">
                <span>📸 Crop & Rotate Image</span>
            </div>
            <div class="crop-content">
                <img id="cropImage" class="crop-image" alt="Image to crop">
                <div class="crop-controls">
                    <button class="crop-btn crop-btn-secondary" onclick="rotateCropImage(-90)">↺ Rotate Left</button>
                    <button class="crop-btn crop-btn-secondary" onclick="rotateCropImage(90)">↻ Rotate Right</button>
                    <button class="crop-btn crop-btn-secondary" onclick="resetCrop()">🔄 Reset</button>
                    <button class="crop-btn crop-btn-primary" onclick="applyCrop()">✅ Apply & Add</button>
                    <button class="crop-btn crop-btn-secondary" onclick="cancelCrop()">❌ Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let overviewMap;
        let observations = [];
        let observationCount = 0;
        let currentPropertyCoords = null;
        let cropper = null;
        let currentFileInput = null;
        let currentObservationIndex = null;

        // MapTiler API configuration
        const MAPTILER_API_KEY = 'pk.eyJ1IjoibWFudXMtZGV2IiwiYSI6ImNtNXFqNGNjNzBhZGsyanM5ZXZjdGZxZjAifQ.gQR7QhUNhJGJKEHBhJhJhQ';
        
        // Check API key and update status
        function checkAPIStatus() {
            const statusElement = document.getElementById('apiStatus');
            if (MAPTILER_API_KEY && MAPTILER_API_KEY !== 'your-maptiler-api-key-here') {
                statusElement.innerHTML = '<strong>✅ MapTiler API key detected!</strong> Full mapping features are enabled with interactive maps and real-time geocoding.';
            } else {
                statusElement.innerHTML = '<strong>⚠️ MapTiler API key missing!</strong> Using fallback mode with limited features.';
                statusElement.style.background = '#fff3cd';
                statusElement.style.color = '#856404';
                statusElement.style.borderColor = '#ffc107';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIStatus();
            initializeSlackStatus();
            setDefaultDate();
            addObservation(); // Add first observation
            initializeOverviewMap();
            setupAddressAutocomplete();
        });

        // Set default inspection date to today
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspectionDate').value = today;
        }

        // Initialize Slack status monitoring
        function initializeSlackStatus() {
            const tokenInput = document.getElementById('slackToken');
            const channelInput = document.getElementById('slackChannel');
            const statusDiv = document.getElementById('slackStatus');

            function updateSlackStatus() {
                const token = tokenInput.value.trim();
                const channel = channelInput.value.trim();
                
                if (token && token.startsWith('xoxb-') && channel) {
                    statusDiv.innerHTML = '✅ Slack integration enabled - PDF files will be uploaded to ' + channel;
                    statusDiv.style.background = 'rgba(76, 175, 80, 0.2)';
                    statusDiv.style.borderColor = 'rgba(76, 175, 80, 0.3)';
                } else {
                    statusDiv.innerHTML = 'Slack file upload disabled - Add Bot Token (xoxb-...) to enable direct PDF file upload to #roof-inspections';
                    statusDiv.style.background = 'rgba(255,255,255,0.1)';
                    statusDiv.style.borderColor = 'rgba(255,255,255,0.2)';
                }
            }

            tokenInput.addEventListener('input', updateSlackStatus);
            channelInput.addEventListener('input', updateSlackStatus);
        }

        // Address autocomplete functionality
        function setupAddressAutocomplete() {
            const addressInput = document.getElementById('propertyAddress');
            const suggestionsDiv = document.getElementById('addressSuggestions');
            let debounceTimer;

            addressInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(debounceTimer);
                
                if (query.length < 3) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    searchAddresses(query);
                }, 300);
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // Search addresses using MapTiler Geocoding API
        async function searchAddresses(query) {
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            try {
                const response = await fetch(`https://api.maptiler.com/geocoding/${encodeURIComponent(query)}.json?key=${MAPTILER_API_KEY}&limit=5&types=address,poi`);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    displayAddressSuggestions(data.features);
                } else {
                    // Fallback suggestions
                    displayFallbackSuggestions(query);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                displayFallbackSuggestions(query);
            }
        }

        // Display address suggestions
        function displayAddressSuggestions(features) {
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            suggestionsDiv.innerHTML = '';
            
            features.forEach(feature => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = feature.place_name;
                div.addEventListener('click', () => selectAddress(feature));
                suggestionsDiv.appendChild(div);
            });
            
            suggestionsDiv.style.display = 'block';
        }

        // Display fallback suggestions
        function displayFallbackSuggestions(query) {
            const suggestionsDiv = document.getElementById('addressSuggestions');
            const fallbackSuggestions = [
                `${query}, Florida, United States`,
                `${query}, California, United States`,
                `${query}, Texas, United States`,
                `${query}, New York, United States`
            ];
            
            suggestionsDiv.innerHTML = '';
            
            fallbackSuggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion;
                div.addEventListener('click', () => selectFallbackAddress(suggestion));
                suggestionsDiv.appendChild(div);
            });
            
            suggestionsDiv.style.display = 'block';
        }

        // Select address from suggestions
        function selectAddress(feature) {
            const addressInput = document.getElementById('propertyAddress');
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            addressInput.value = feature.place_name;
            suggestionsDiv.style.display = 'none';
            
            // Store coordinates for map centering
            currentPropertyCoords = feature.center;
            
            // Update all maps to center on this location
            updateMapsLocation(feature.center);
        }

        // Select fallback address
        function selectFallbackAddress(address) {
            const addressInput = document.getElementById('propertyAddress');
            const suggestionsDiv = document.getElementById('addressSuggestions');
            
            addressInput.value = address;
            suggestionsDiv.style.display = 'none';
            
            // Use default coordinates for fallback
            currentPropertyCoords = [-80.1918, 25.7617]; // Miami coordinates
            updateMapsLocation(currentPropertyCoords);
        }

        // Update all maps to center on location
        function updateMapsLocation(coordinates) {
            // Update existing observation maps
            observations.forEach((obs, index) => {
                if (obs.map) {
                    obs.map.setCenter(coordinates);
                    obs.map.setZoom(18);
                }
            });
            
            // Update overview map
            if (overviewMap) {
                overviewMap.setCenter(coordinates);
                overviewMap.setZoom(16);
            }
        }

        // Initialize overview map
        function initializeOverviewMap() {
            mapboxgl.accessToken = MAPTILER_API_KEY;
            
            overviewMap = new mapboxgl.Map({
                container: 'overviewMap',
                style: 'mapbox://styles/mapbox/satellite-v9',
                center: currentPropertyCoords || [-80.1918, 25.7617],
                zoom: 16,
                attributionControl: false
            });

            overviewMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
            
            overviewMap.on('load', function() {
                updateOverviewStats();
            });
        }

        // Add new observation
        function addObservation() {
            observationCount++;
            const observationId = `observation-${observationCount}`;
            
            const observationHTML = `
                <div class="observation-card" id="${observationId}">
                    <div class="observation-header">
                        Observation #${observationCount}:
                    </div>
                    
                    <div class="form-group">
                        <textarea placeholder="Describe the observation..." rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Upload Photos:</label>
                        <div class="photo-upload" onclick="document.getElementById('photo-${observationCount}').click()">
                            <div class="photo-upload-icon">📸</div>
                            <div class="photo-upload-text">Photo Upload with Cropping</div>
                            <div class="photo-upload-subtext">Each photo will open an editing window where you can crop and rotate before adding to the report.</div>
                        </div>
                        <input type="file" id="photo-${observationCount}" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(this, ${observationCount})">
                        <div id="photos-${observationCount}" class="uploaded-photos"></div>
                    </div>
                    
                    <div class="form-group">
                        <div class="map-label">Issue Location:</div>
                        <div class="map-instructions">Click on the map to mark the exact location of this issue</div>
                        <div class="map-container" id="map-container-${observationCount}">
                            <div id="map-${observationCount}"></div>
                        </div>
                        <div id="location-${observationCount}" class="location-marker" style="display: none;"></div>
                    </div>
                    
                    <button class="btn btn-danger" onclick="removeObservation('${observationId}')">Remove Observation</button>
                </div>
            `;
            
            document.getElementById('observationsContainer').insertAdjacentHTML('beforeend', observationHTML);
            
            // Initialize map for this observation
            initializeObservationMap(observationCount);
            
            // Store observation data
            observations.push({
                id: observationId,
                number: observationCount,
                map: null,
                marker: null,
                coordinates: null,
                photos: []
            });
        }

        // Initialize map for specific observation
        function initializeObservationMap(observationNumber) {
            mapboxgl.accessToken = MAPTILER_API_KEY;
            
            const map = new mapboxgl.Map({
                container: `map-${observationNumber}`,
                style: 'mapbox://styles/mapbox/satellite-v9',
                center: currentPropertyCoords || [-80.1918, 25.7617],
                zoom: 18,
                attributionControl: false
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            
            // Add click handler for marking locations
            map.on('click', function(e) {
                markLocation(observationNumber, e.lngLat);
            });
            
            // Store map reference
            const obsIndex = observations.findIndex(obs => obs.number === observationNumber);
            if (obsIndex !== -1) {
                observations[obsIndex].map = map;
            }
        }

        // Mark location on map
        function markLocation(observationNumber, coordinates) {
            const obsIndex = observations.findIndex(obs => obs.number === observationNumber);
            if (obsIndex === -1) return;
            
            const observation = observations[obsIndex];
            
            // Remove existing marker
            if (observation.marker) {
                observation.marker.remove();
            }
            
            // Add new marker
            const marker = new mapboxgl.Marker({
                color: '#e74c3c'
            })
            .setLngLat(coordinates)
            .addTo(observation.map);
            
            // Update observation data
            observation.marker = marker;
            observation.coordinates = coordinates;
            
            // Display coordinates
            const locationDiv = document.getElementById(`location-${observationNumber}`);
            locationDiv.innerHTML = `📍 Location Marked! GPS: ${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}`;
            locationDiv.style.display = 'block';
            
            // Update overview map
            updateOverviewMap();
        }

        // Handle photo upload with cropping
        function handlePhotoUpload(input, observationNumber) {
            const files = Array.from(input.files);
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    currentFileInput = input;
                    currentObservationIndex = observationNumber;
                    openCropModal(file);
                }
            });
        }

        // Open crop modal
        function openCropModal(file) {
            const modal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                cropImage.src = e.target.result;
                modal.style.display = 'block';
                
                // Initialize cropper
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(cropImage, {
                    aspectRatio: NaN, // Free aspect ratio
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false
                });
            };
            reader.readAsDataURL(file);
        }

        // Rotate crop image
        function rotateCropImage(degrees) {
            if (cropper) {
                cropper.rotate(degrees);
            }
        }

        // Reset crop
        function resetCrop() {
            if (cropper) {
                cropper.reset();
            }
        }

        // Apply crop and add to observation
        function applyCrop() {
            if (!cropper || !currentObservationIndex) return;
            
            const canvas = cropper.getCroppedCanvas({
                maxWidth: 1200,
                maxHeight: 1200,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob(function(blob) {
                const croppedFile = new File([blob], `cropped-photo-${Date.now()}.jpg`, {
                    type: 'image/jpeg'
                });
                
                addPhotoToObservation(croppedFile, currentObservationIndex);
                cancelCrop();
            }, 'image/jpeg', 0.9);
        }

        // Cancel crop
        function cancelCrop() {
            const modal = document.getElementById('cropModal');
            modal.style.display = 'none';
            
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            currentFileInput = null;
            currentObservationIndex = null;
        }

        // Add photo to observation
        function addPhotoToObservation(file, observationNumber) {
            const obsIndex = observations.findIndex(obs => obs.number === observationNumber);
            if (obsIndex === -1) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = {
                    file: file,
                    dataUrl: e.target.result,
                    name: file.name
                };
                
                observations[obsIndex].photos.push(photoData);
                displayPhoto(photoData, observationNumber);
            };
            reader.readAsDataURL(file);
        }

        // Display photo in observation
        function displayPhoto(photoData, observationNumber) {
            const photosContainer = document.getElementById(`photos-${observationNumber}`);
            
            const photoDiv = document.createElement('div');
            photoDiv.style.cssText = `
                display: inline-block;
                margin: 10px;
                padding: 10px;
                border: 2px solid #e1e8ed;
                border-radius: 8px;
                background: white;
                text-align: center;
                position: relative;
            `;
            
            photoDiv.innerHTML = `
                <img src="${photoData.dataUrl}" style="max-width: 150px; max-height: 150px; border-radius: 4px;">
                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${photoData.name}</p>
                <button onclick="removePhoto(this, ${observationNumber})" style="
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: #e74c3c;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 25px;
                    height: 25px;
                    cursor: pointer;
                    font-size: 12px;
                ">×</button>
            `;
            
            photosContainer.appendChild(photoDiv);
        }

        // Remove photo
        function removePhoto(button, observationNumber) {
            const photoDiv = button.parentElement;
            const photoName = photoDiv.querySelector('p').textContent;
            
            // Remove from observations array
            const obsIndex = observations.findIndex(obs => obs.number === observationNumber);
            if (obsIndex !== -1) {
                observations[obsIndex].photos = observations[obsIndex].photos.filter(
                    photo => photo.name !== photoName
                );
            }
            
            // Remove from DOM
            photoDiv.remove();
        }

        // Update overview map with all markers
        function updateOverviewMap() {
            if (!overviewMap) return;
            
            // Clear existing markers
            const existingMarkers = document.querySelectorAll('.overview-marker');
            existingMarkers.forEach(marker => marker.remove());
            
            // Add numbered markers for each observation with coordinates
            const validObservations = observations.filter(obs => obs.coordinates);
            
            validObservations.forEach((obs, index) => {
                // Create custom marker element
                const markerElement = document.createElement('div');
                markerElement.className = 'overview-marker';
                markerElement.style.cssText = `
                    background: #e74c3c;
                    color: white;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 24px;
                    border: 4px solid white;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    font-family: Arial, sans-serif;
                `;
                markerElement.textContent = obs.number;
                
                new mapboxgl.Marker(markerElement)
                    .setLngLat(obs.coordinates)
                    .addTo(overviewMap);
            });
            
            // Fit map to show all markers
            if (validObservations.length > 0) {
                const coordinates = validObservations.map(obs => obs.coordinates);
                const bounds = new mapboxgl.LngLatBounds();
                coordinates.forEach(coord => bounds.extend(coord));
                
                if (coordinates.length === 1) {
                    overviewMap.setCenter(coordinates[0]);
                    overviewMap.setZoom(18);
                } else {
                    overviewMap.fitBounds(bounds, { padding: 50 });
                }
            }
            
            updateOverviewStats();
        }

        // Update overview statistics
        function updateOverviewStats() {
            const statsDiv = document.getElementById('overviewStats');
            const markedLocations = observations.filter(obs => obs.coordinates).length;
            
            let statsHTML = `
                <h4>🗺️ Overview Map - ${markedLocations} Issue Location${markedLocations !== 1 ? 's' : ''} Marked</h4>
                <p>Total issue locations marked: ${markedLocations}</p>
            `;
            
            if (markedLocations > 0) {
                observations.forEach(obs => {
                    if (obs.coordinates) {
                        statsHTML += `<p>Issue ${obs.number}: ${obs.coordinates.lat.toFixed(6)}, ${obs.coordinates.lng.toFixed(6)}</p>`;
                    }
                });
            } else {
                statsHTML += `<p>Mark locations on individual observation maps to see them here</p>`;
            }
            
            statsDiv.innerHTML = statsHTML;
        }

        // Remove observation
        function removeObservation(observationId) {
            // Remove from DOM
            document.getElementById(observationId).remove();
            
            // Remove from observations array
            const obsIndex = observations.findIndex(obs => obs.id === observationId);
            if (obsIndex !== -1) {
                observations.splice(obsIndex, 1);
            }
            
            // Update overview map
            updateOverviewMap();
        }

        // Capture overview map for PDF with enhanced quality
        async function captureOverviewMapForPDF() {
            const mapContainer = document.getElementById('overviewMapContainer');
            
            // Ensure map is fully loaded
            await new Promise(resolve => {
                if (overviewMap.loaded()) {
                    resolve();
                } else {
                    overviewMap.once('load', resolve);
                }
            });

            // Force map repaint and wait for idle state
            overviewMap.triggerRepaint();
            await new Promise(resolve => {
                overviewMap.once('idle', resolve);
            });

            // Additional wait for markers to fully render
            await new Promise(resolve => setTimeout(resolve, 3000));

            // Capture with high quality settings for landscape format
            const canvas = await html2canvas(mapContainer, {
                useCORS: true,
                allowTaint: true,
                scale: 2, // High resolution
                width: 1600, // Landscape width
                height: 900, // Landscape height
                backgroundColor: '#ffffff',
                logging: false,
                imageTimeout: 15000,
                removeContainer: false
            });

            return canvas.toDataURL('image/jpeg', 0.95);
        }

        // Generate PDF with landscape overview map
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            // Create PDF in portrait mode (individual pages) with landscape overview
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Get form data
            const propertyAddress = document.getElementById('propertyAddress').value || 'Not specified';
            const inspectorName = document.getElementById('inspectorName').value;
            const roofType = document.getElementById('roofType').value;
            const roofCondition = document.getElementById('roofCondition').value;
            const inspectionDate = document.getElementById('inspectionDate').value;
            
            // Add logo if available
            try {
                const logoImg = await loadImage('Logo seal e slogan@2x (1).png');
                pdf.addImage(logoImg, 'PNG', 15, 15, 40, 20);
            } catch (error) {
                console.log('Logo not found, continuing without logo');
            }
            
            // Title
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('SEAL TOP ROOF', pageWidth / 2, 30, { align: 'center' });
            
            pdf.setFontSize(18);
            pdf.text('Roof Inspection Report', pageWidth / 2, 40, { align: 'center' });
            
            // Property information
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            let yPos = 60;
            
            pdf.text(`Property: ${propertyAddress}`, 20, yPos);
            yPos += 10;
            pdf.text(`Inspector: ${inspectorName}`, 20, yPos);
            yPos += 10;
            pdf.text(`Date: ${inspectionDate}`, 20, yPos);
            yPos += 10;
            pdf.text(`Roof Type: ${roofType}`, 20, yPos);
            yPos += 10;
            pdf.text(`Condition: ${roofCondition}`, 20, yPos);
            yPos += 20;
            
            // Observations
            const validObservations = observations.filter(obs => {
                const card = document.getElementById(obs.id);
                const description = card.querySelector('textarea').value.trim();
                return description || obs.coordinates || obs.photos.length > 0;
            });
            
            for (let i = 0; i < validObservations.length; i++) {
                const obs = validObservations[i];
                const card = document.getElementById(obs.id);
                const description = card.querySelector('textarea').value.trim();
                
                // Check if we need a new page
                if (yPos > pageHeight - 60) {
                    pdf.addPage();
                    yPos = 20;
                }
                
                // Observation header
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Observation #${obs.number}:`, 20, yPos);
                yPos += 15;
                
                // Description
                if (description) {
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'normal');
                    const lines = pdf.splitTextToSize(description, pageWidth - 40);
                    pdf.text(lines, 20, yPos);
                    yPos += lines.length * 5 + 10;
                }
                
                // GPS coordinates
                if (obs.coordinates) {
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'italic');
                    pdf.text(`GPS: ${obs.coordinates.lat.toFixed(6)}, ${obs.coordinates.lng.toFixed(6)}`, 20, yPos);
                    yPos += 10;
                }
                
                // Photos
                for (let j = 0; j < obs.photos.length; j++) {
                    const photo = obs.photos[j];
                    
                    // Check if we need a new page for photo
                    if (yPos > pageHeight - 80) {
                        pdf.addPage();
                        yPos = 20;
                    }
                    
                    try {
                        const imgWidth = 80;
                        const imgHeight = 60;
                        pdf.addImage(photo.dataUrl, 'JPEG', 20, yPos, imgWidth, imgHeight);
                        yPos += imgHeight + 10;
                    } catch (error) {
                        console.error('Error adding photo to PDF:', error);
                    }
                }
                
                yPos += 10;
            }
            
            // LANDSCAPE OVERVIEW MAP PAGE
            if (validObservations.some(obs => obs.coordinates)) {
                // Add new page in LANDSCAPE orientation
                pdf.addPage('a4', 'landscape');
                const landscapeWidth = pdf.internal.pageSize.getWidth(); // Now wider
                const landscapeHeight = pdf.internal.pageSize.getHeight(); // Now shorter
                
                // Title for overview page
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.text('Overview Map - All Issue Locations', landscapeWidth / 2, 25, { align: 'center' });
                
                // Property info on landscape page
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Property: ${propertyAddress}`, 20, 40);
                pdf.text(`Total Issues: ${validObservations.filter(obs => obs.coordinates).length}`, 20, 50);
                
                try {
                    // Capture overview map with landscape dimensions
                    const mapDataUrl = await captureOverviewMapForPDF();
                    
                    // Add map image in landscape format - MUCH LARGER
                    const mapWidth = landscapeWidth - 40; // Almost full width
                    const mapHeight = landscapeHeight - 80; // Almost full height
                    pdf.addImage(mapDataUrl, 'JPEG', 20, 60, mapWidth, mapHeight);
                    
                } catch (error) {
                    console.error('Error capturing overview map:', error);
                    pdf.setFontSize(12);
                    pdf.text('Overview map could not be captured', 20, 80);
                }
                
                // Add coordinates list
                let coordsY = landscapeHeight - 15;
                pdf.setFontSize(8);
                validObservations.forEach(obs => {
                    if (obs.coordinates) {
                        pdf.text(`Issue ${obs.number}: ${obs.coordinates.lat.toFixed(6)}, ${obs.coordinates.lng.toFixed(6)}`, 20, coordsY);
                        coordsY -= 8;
                    }
                });
            }
            
            // Save and send to Slack
            const fileName = `Roof_Inspection_Report_${propertyAddress.replace(/[^a-zA-Z0-9]/g, '_')}_${inspectionDate}.pdf`;
            
            try {
                await sendToSlack(pdf, fileName, propertyAddress, validObservations.length);
            } catch (error) {
                console.error('Slack upload failed:', error);
                // Fallback: download locally
                pdf.save(fileName);
                alert('PDF generated and downloaded locally. Slack upload failed - please check your Bot Token configuration.');
            }
        }

        // Send PDF to Slack
        async function sendToSlack(pdf, fileName, propertyAddress, observationCount) {
            const slackToken = document.getElementById('slackToken').value.trim();
            const slackChannel = document.getElementById('slackChannel').value.trim();
            
            if (!slackToken || !slackToken.startsWith('xoxb-')) {
                throw new Error('Invalid Slack Bot Token');
            }
            
            // Convert PDF to blob
            const pdfBlob = pdf.output('blob');
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('file', pdfBlob, fileName);
            formData.append('channels', slackChannel.replace('#', '')); // Remove # from channel name
            formData.append('title', `Roof Inspection Report - ${propertyAddress}`);
            formData.append('initial_comment', `🏠 **SEAL TOP ROOF Inspector - Enhanced Roof Inspection Report Generated**\n\n📋 **Property:** ${propertyAddress}\n👨‍🔧 **Inspector:** ${document.getElementById('inspectorName').value}\n📅 **Date:** ${document.getElementById('inspectionDate').value}\n🏠 **Roof Type:** ${document.getElementById('roofType').value}\n⚖️ **Condition:** ${document.getElementById('roofCondition').value}\n📍 **Observations:** ${observationCount} issue(s) documented\n🗺️ **Enhanced:** Landscape overview map with image cropping\n\n📄 **Download PDF Report** ⬇️`);
            
            const response = await fetch('https://slack.com/api/files.upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${slackToken}`
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.ok) {
                alert(`✅ PDF successfully uploaded to ${slackChannel}!\n\nEnhanced features included:\n• Landscape overview map\n• Image cropping functionality\n• Mobile-optimized interface`);
            } else {
                console.error('Slack API error:', result);
                throw new Error(`Slack upload failed: ${result.error || 'Unknown error'}`);
            }
        }

        // Helper function to load images
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        // Close crop modal when clicking outside
        document.getElementById('cropModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelCrop();
            }
        });
    </script>
</body>
</html>

